%{if $has_header}%
<table width="100%" border="0" cellpadding="1" cellspacing="0" class="blacktable">
<thead>
<tr align="left" valign="top">
	<th scope="col" width="*" style="min-width:200px;" class="kompl3">
    
    </th>
	%{foreach name=msec from=$items[10].data_short item=month}%
   
    <th scope="col" width="80" style="min-width: 80px !important; width:80px; " class="kompl3">
    <strong> %{$month}%</strong>
    </th>
    
    %{/foreach}%
    
    <th scope="col" width="24" class="kompl3">
    
    </th>
</tr>
</thead>
<tbody >

%{/if}% 
%{foreach name=supsec from=$items item=recgr}%
%{if $recgr.account_group!=10}% 
   <tr align="left" valign="top" id="our_bdds_row_%{$recgr.account_group}%">
  
  	<td width="*" style="min-width:200px;" class="kompl2">
   <strong> %{$recgr.name}%  </strong>
   
   
   %{if $can_modify and ( $recgr.account_group==0 or  $recgr.account_group==1)}%
   
   <a href="#" id="bdds_add_account_%{$recgr.account_group}%" data-comment="добавить позицию в группу %{$recgr.name|escape:"html"}%" class="reestr_add16 reestr_button16" style="float:right;" />
   %{/if}%
    </td>
  
   <!-- итерация по месяцам -->
   %{foreach name=fr from=$recgr.data_short item=val}%
   <td width="80"  style="min-width: 80px !important; width:80px; "  class="kompl2">
   <strong>%{$recgr.data_short_formatted[$smarty.foreach.fr.index]}%	 </strong>
   
   
   </td>
   %{/foreach}%
   
   
   <td width="24" class="kompl2">
    
    </td>
    
   </tr>
   <!-- итерация по статьям -->
   %{foreach from=$recgr.subs item=account}% 
   <tr align="left" valign="top" id="account_row_%{$account.account_id}%">
   	<td width="*" style="min-width:200px;" class="kompl1">
    <span id="bdds_account_%{$account.account_id}%">%{$account.name}%</span>
    
    %{if $can_modify}%
      <a href="#" id="bdds_edit_account_%{$account.account_id}%" data-comment="редактировать %{$account.name|escape:"html"}%" class="reestr_edit16 reestr_button16" style="float:right;" />
      
    %{/if}%  
    </td>
    
    <!-- итерация по месяцам -->
   %{foreach name=fm from=$account.data_short item=val}%
   <td width="120"  style="min-width: 120px !important; width:120px; "  class="kompl1">
   <span id="bdds_values_%{$recgr.account_group}%_%{$account.account_id}%_%{$account.monthes[$smarty.foreach.fm.index]}%_%{$account.years[$smarty.foreach.fm.index]}%">
   %{$account.data_short_formatted[$smarty.foreach.fm.index]}%
   
   </span>
   
   <input type="hidden" value="%{$val}%" id="bdds_value_%{$recgr.account_group}%_%{$account.account_id}%_%{$account.monthes[$smarty.foreach.fm.index]}%_%{$account.years[$smarty.foreach.fm.index]}%"  name="bdds_value_%{$recgr.account_group}%_%{$account.account_id}%_%{$account.monthes[$smarty.foreach.fm.index]}%_%{$account.years[$smarty.foreach.fm.index]}%"  />
   <!--bdds_value_%{$recgr.account_group}%_%{$account.account_id}%_%{$account.monthes[$smarty.foreach.fm.index]}%_%{$account.years[$smarty.foreach.fm.index]}%-->
   
   
	%{if $can_modify}%
   %{if $val==""}%
   <a href="#" id="bdds_add_cost_%{$recgr.account_group}%_%{$account.account_id}%_%{$account.monthes[$smarty.foreach.fm.index]}%_%{$account.years[$smarty.foreach.fm.index]}%" data-comment="добавить %{$account.name|escape:"html"}% за %{$account.monthes[$smarty.foreach.fm.index]|string_format:"%02d"}%.%{$account.years[$smarty.foreach.fm.index]}%" class="reestr_add16 reestr_button16" style="float:right;" />
   %{else}%
    <a href="#" id="bdds_del_cost_%{$recgr.account_group}%_%{$account.account_id}%_%{$account.monthes[$smarty.foreach.fm.index]}%_%{$account.years[$smarty.foreach.fm.index]}%" data-comment="удалить %{$account.name|escape:"html"}% за %{$account.monthes[$smarty.foreach.fm.index]|string_format:"%02d"}%.%{$account.years[$smarty.foreach.fm.index]}%" class="reestr_delete16 reestr_button16" style="float:right;" />
     <a href="#" id="bdds_edit_cost_%{$recgr.account_group}%_%{$account.account_id}%_%{$account.monthes[$smarty.foreach.fm.index]}%_%{$account.years[$smarty.foreach.fm.index]}%"  data-comment="редактировать %{$account.name|escape:"html"}% за %{$account.monthes[$smarty.foreach.fm.index]|string_format:"%02d"}%.%{$account.years[$smarty.foreach.fm.index]}%" class="reestr_edit16 reestr_button16" style="float:right;" />
   %{/if}%
   %{/if}%
   
   </td>
   %{/foreach}%
   
   <td width="24" class="kompl1">
    %{if $can_modify}%
     <a href="#" id="bdds_delete_account_%{$account.account_id}%" data-comment="удалить %{$account.name|escape:"html"}% " class="reestr_delete reestr_right_button24" />
    %{else}% 
    <a href="#" onClick="return false;" data-comment="удалить %{$account.name|escape:"html"}% " class="reestr_delete reestr_inactive reestr_right_button24" />
    %{/if}%
    </td>
    
   </tr>
   %{/foreach}% 
%{/if}%  
%{/foreach}%
%{if $has_header}%  
</tbody>
</table>
<br>

<div align="right">
<strong><em>Проверка 
= ЧП по проекту - кон. остаток ДС по проекту:<br>
 %{$check_formatted}%&nbsp;руб.</em></strong>
</div>
 


<div id="bdds_sum_dialog" title="Укажите сумму" style="display:none;">
	<label for="bdds_sum_cost">Сумма, руб.:</label><br>
	<input type="text" value="" id="bdds_sum_cost" size="20" maxlength="255" />
    
</div>

<div id="bdds_account_dialog" title="Позиция БДДС" style="display:none;">
	<label for="bdds_account_name">Название позиции:</label><br>
	<input type="text" value="" id="bdds_account_name" size="40" maxlength="255" />
    
    
  <!--  <label for="bdds_sum_cost">Количество, шт.:</label><br>
	<input type="text" value="" id="bdds_sum_cost" size="20" maxlength="255" />-->
    
</div>


%{if $can_modify}%
<script>
$(function(){
	
	$("#bdds_sum_dialog").dialog({
		autoOpen: false,
		dialogClass: 'semi_auth',
		modal: true,
		width: 250,
		height: 150,
		dialogClass: 'semi_auth',
		buttons: {
			"Готово": function(){
				
				
				
			},
			"Отмена": function(){
				 $(this).dialog("close"); 
			}
		}
	});
	
	$("#bdds_account_dialog").dialog({
		autoOpen: false,
		dialogClass: 'semi_auth',
		modal: true,
		width: 350,
		height: 150,
		dialogClass: 'semi_auth',
		buttons: {
			"Готово": function(){
				
				
				
			},
			"Отмена": function(){
				 $(this).dialog("close"); 
			}
		}
	});
	
	
	 
	
	
	function RedrawTable(){
		ds_account_ids=new Array(); ds_account_values=new Array();
		$.each($("input[id^=bdds_value_]"), function(k,v){
			id=$(v).attr("id");
			hashed="";
			hashed+=id.replace(/^bdds_value_/,'');
			
			hashed+="_"+$(v).val();
			
			//alert(hashed);
			
			ds_account_values.push(hashed);
			account_id=id.replace(/^bdds_value_/,'').replace(/^([0-9]+)_/,'').replace(/_([0-9]+)_([0-9]+)$/,'');
			
			if($.inArray(account_id, ds_account_ids)==-1) ds_account_ids.push(account_id);
			//alert(	account_id);	
			
		});
		
		//alert(ds_account_values);
		
		$.ajax({
			async: true,
			url: "/js/bdrs.php",
			type: "POST",
			data:{
				"action":"redraw_bdds",
				
				"id":$("#id").val(),
				"ds_account_ids[]": ds_account_ids,
				"ds_account_values[]":ds_account_values
			},
			beforeSend: function(){
				 $("#bdds_block_set").prop("disabled",true); 
				 $("#bdds_block_set input").prop("disabled",true); 
				 $("#bdds_block_set textarea").prop("disabled",true); 
				 $("#bdds_block_set .reestr_button16").hide();
				 $("#bdds_block_set .reestr_right_button24").hide();
			},
			success: function(data){
			 	 $("#bdds_block_set").html(data);
			  
			},
			error: function(xhr, status){
				
			},
			complete: function(xhr, status){
				 $("#bdds_block_set").prop("disabled",false);
				 $("#bdds_block_set input").prop("disabled",false); 
				 $("#bdds_block_set textarea").prop("disabled",false); 
				 
				 $("#bdds_block_set .reestr_button16").show();
				 $("#bdds_block_set .reestr_right_button24").show(); 
			}		 
		});
	}
	
	 
	
	//добавка статьи
	$("a[id^=bdds_add_account_]").bind("click", function(){
		
		var link_id=$(this).attr("id");
		
		
		$("#bdds_account_dialog").dialog({
		 
				buttons: {
				"Готово": function(){
					//alert();
					can_ret=true;
					
					name=$.trim($("#bdds_account_name").val());
					if(can_ret&&((name.length==0))){
						can_ret=can_ret&&false;
						alert("Введите название позиции!");	
						$("#bdds_account_name").focus();
					}
					 
					
					if(can_ret){
						p_or_m=	link_id.replace(/^bdds_add_account_/,'');
						//ввод статьи
						
						
						$.ajax({
							async: true,
							url: "/js/bdrs.php",
							type: "POST",
							data:{
								"action":"add_account",
								"p_or_m":p_or_m,
								"id":$("#id").val(),
								"name": name
							},
							beforeSend: function(){
								 
							},
							success: function(data){
								$("#bdds_account_dialog").dialog("close"); 
								RedrawTable();
							  
							},
							error: function(xhr, status){
								
							},
							complete: function(xhr, status){
								 
							}		 
						});
						
						
						
					} 
					
				},
				"Отмена": function(){
					 $(this).dialog("close"); 
				}
			}
		});
		
		$("#bdds_account_name").val('');
		$("#bdds_account_dialog").dialog("open");
		
		
		
		return false;
	});
	
	
	//правка статьи
	$("a[id^=bdds_edit_account_]").bind("click", function(){
		
		var link_id=$(this).attr("id");
		
		
		$("#bdds_account_dialog").dialog({
		 
				buttons: {
				"Готово": function(){
					//alert();
					can_ret=true;
					
					name=$.trim($("#bdds_account_name").val());
					if(can_ret&&((name.length==0))){
						can_ret=can_ret&&false;
						alert("Введите название позиции!");	
						$("#bdds_account_name").focus();
					}
					 
					
					if(can_ret){
						id=	link_id.replace(/^bdds_edit_account_/,'');
						//ввод статьи
						
						
						$.ajax({
							async: true,
							url: "/js/bdrs.php",
							type: "POST",
							data:{
								"action":"edit_account",
								
								"id":$("#id").val(),
								"account_id":id,
								"name": name
							},
							beforeSend: function(){
								 
							},
							success: function(data){
								$("#bdds_account_dialog").dialog("close"); 
								RedrawTable();
							  
							},
							error: function(xhr, status){
								
							},
							complete: function(xhr, status){
								 
							}		 
						});
						
						
						
					} 
					
				},
				"Отмена": function(){
					 $(this).dialog("close"); 
				}
			}
		});
		
		 
		$("#bdds_account_name").val($("#bdds_account_"+link_id.replace(/^bdds_edit_account_/,'')).html()  );
		$("#bdds_account_dialog").dialog("open");
		
		
		
		return false;
	});
	
	
	 
	
	//удаление статьи
	$("a[id^=bdds_delete_account_]").bind("click", function(){
		
		var link_id=$(this).attr("id");
		
		
		if(window.confirm("Вы действительно хотите удалить позицию?")){
			id=	link_id.replace(/^bdds_delete_account_/,'');
			$.ajax({
							async: true,
							url: "/js/bdrs.php",
							type: "POST",
							data:{
								"action":"delete_account",
								
								"id":$("#id").val(),
								"account_id":id,
								"name": name
							},
							beforeSend: function(){
								 
							},
							success: function(data){
								$("#bdds_account_dialog").dialog("close"); 
								RedrawTable();
							  
							},
							error: function(xhr, status){
								
							},
							complete: function(xhr, status){
								 
							}		 
						});
		}
		
		 
		
		return false;
	});
	
	
	
	
	
	//добавка суммы
	$("a[id^=bdds_add_cost_]").bind("click", function(){
		
		var link_id=$(this).attr("id");
		//account_id=id.replace(/^bdds_value_/,'').replace(/^([0-9]+)_/,'').replace(/_([0-9]+)_([0-9]+)$/,'');*/
		
		$("#bdds_sum_dialog").dialog({
		 
				buttons: {
				"Готово": function(){
					//alert();
					can_ret=true;
					sum=$.trim($("#bdds_sum_cost").val().replace(/\,/,'.'));
					if(can_ret&&(isNaN(sum)||(parseFloat(sum)<0)||(sum.length==0))){
						can_ret=can_ret&&false;
						alert("Введите корректную сумму!");	
						$("#bdds_sum_cost").focus();
					}
					
					if(can_ret){
						hv=	link_id.replace(/^bdds_add_cost_/,'');
						$("#bdds_value_"+hv).val(sum);
						$("#bdds_values_"+hv).html(sum);
						
						$(this).dialog("close"); 
						RedrawTable();
						
					}
					
				},
				"Отмена": function(){
					 $(this).dialog("close"); 
				}
			}
		});
		
		
		$("#bdds_sum_cost").val('');
		$("#bdds_sum_dialog").dialog("open");
		
		
		return false;
	});
	
	//удаление суммы
	$("a[id^=bdds_del_cost_]").bind("click", function(){
		
		var link_id=$(this).attr("id");
		
		if(window.confirm("Внимание! Вы действительно хотите удалить сумму?")){
			hv=	link_id.replace(/^bdds_del_cost_/,'');
						$("#bdds_value_"+hv).val('');
						$("#bdds_values_"+hv).html('');
				$(this).dialog("close"); 
						RedrawTable();		
		}				
				
		return false;
	});
	
	
	//правка суммы
	$("a[id^=bdds_edit_cost_]").bind("click", function(){
		
		var link_id=$(this).attr("id");
		//account_id=id.replace(/^bdds_value_/,'').replace(/^([0-9]+)_/,'').replace(/_([0-9]+)_([0-9]+)$/,'');*/
		
		$("#bdds_sum_dialog").dialog({
		 
				buttons: {
				"Готово": function(){
					//alert();
					can_ret=true;
					sum=$.trim($("#bdds_sum_cost").val().replace(/\,/,'.'));
					if(can_ret&&(isNaN(sum)||(parseFloat(sum)<0)||(sum.length==0))){
						can_ret=can_ret&&false;
						alert("Введите корректную сумму!");	
						$("#bdds_sum_cost").focus();
					}
					
					if(can_ret){
						hv=	link_id.replace(/^bdds_edit_cost_/,'');
						$("#bdds_value_"+hv).val(sum);
						$("#bdds_values_"+hv).html(sum);
						
						$(this).dialog("close"); 
						RedrawTable();
						
					}
					
				},
				"Отмена": function(){
					 $(this).dialog("close"); 
				}
			}
		});
		
		
		hv=	link_id.replace(/^bdds_edit_cost_/,'');
		$("#bdds_sum_cost").val($("#bdds_value_"+hv).val());
		$("#bdds_sum_dialog").dialog("open");
		
		
		return false;
	});
	
	
	
 
});
</script>
%{/if}%
%{/if}%
 

