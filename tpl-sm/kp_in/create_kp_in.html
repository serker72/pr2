<script type="text/javascript" src="/js/gen_validatorv4.js"></script>
<script type="text/javascript" src="/js/jquery.mask.min.js"></script>
<script type="text/javascript">
$(function(){
	
	$.datepicker.setDefaults($.extend($.datepicker.regional['ru']));
	 
	
 
	 
	$("#given_pdate").datepicker({changeMonth: true, changeYear:true, yearRange: '2012:+15'});
	 
	  
	 
	 
	
	 
	
	
	function ZeroFormat(val){
		val=""+val;
		
		if(val.length==1) val="0"+val;
		return val;	
	}
	
	 
	 
	 
	
	 
});
</script>

 %{include file="every_help_dialog.html" filename="kp_ins.html" prefix="" description="Информация о создании входящего КП" style="float:right" is_right=true}%



<h1>Создать входящее КП</h1>

<form action="ed_kp_in.php" method="post" id="crea_form">

<input type="hidden" name="action" value="0">
<input type="hidden" name="kind_id" value="0">

<input type="hidden" name="lead_id" id="lead_id" value="%{$lead_id}%"> 
<input type="hidden" name="tz_id" id="tz_id" value="%{$tz_id}%"> 


<div style="float:right; margin-right:0px; min-width:120px; height:50px;">
<a href="#" onclick="$('#do_close').trigger('click'); return false;" style="float:right;" class="reestr_right_button24 reestr_delete" data-comment="Аннулировать/Восстановить...">
 
</a>

<strong>Статус:</strong><br />

создан


</div>

<div style="float:right;  margin-right:10px; height:50px; ">
  <a href="#"   onclick="alert('В данном режиме печать входящего КП недоступна. Пожалуйста, нажмите кнопку Создать входящее КП и остаться в карте для получения возможности печати КП.'); return false;" class="reestr_print reestr_inactive reestr_right_button24" data-comment="печать лида..."></a>
</div>  


<div style="float:left; margin-right:20px; height:50px;">
    
    
        <label for="pdate">
        Дата создания: 
        </label><br />
        
        %{$now_time}%
        <input type="hidden" value="%{$now_date}%" name="pdate" />
    
</div>


  <div style="float:left; white-space:nowrap; margin-right:20px; height:50px;">
     
    <label for="given_pdate">
    Дата КП:
        </label> <br>
    
        
        <input type="text" value="%{$now_date}%" id="given_pdate" name="given_pdate"  size="10"   maxlength="10" style="width:60px;" />
        
      
        
    </div>
 

<div style="float:left; margin-right:20px;  height:50px;">



    
    <label for="lead_str">Лид:</label> <br>

  
    <a href="ed_lead.php?action=1&id=%{$lead_id}%&from_begin=1" target="_blank">%{$lead.code}%</a>
     
	 
</div>


<div style="float:left; margin-right:20px;  height:50px;">



    
    <label for="tz_str">ТЗ:</label> <br>

  
    <a href="ed_tz.php?action=1&id=%{$tz_id}%&from_begin=1" target="_blank">%{$tz.code}%</a>
     
	 
</div>
 

<br clear="all">
<p />


<div style="float:left; margin-right: 0px; width:100%;">
<label for="description">Описание КП:</label><br>
<textarea id="description" name="description" style="width:100%; height:75px;"></textarea>


 
<script type="text/javascript">

 
 
	try{
		$("#description").ckeditor({
              customConfig : '/ckeditor4/config-kp.js',
				width:'99%',
				height:'50px'
            });		
		
	}catch(e){}
	
</script>

</div> 

<br clear="all">
<p />

 <div>
    
    

   <strong>Приложите файлы:</strong><br />


    <input type="file" id="file" /> 
     
    <em>максимальный размер файла: %{php}%echo ini_get("post_max_size");%{/php}%</em>  
    
    <div id="uploaded_files">
        
    </div>
     
     
    
    <script src="/uploadifive/jquery.uploadifive.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="/uploadifive/uploadifive.css">
    
    <div id="queue"></div>
    
    <script type="text/javascript">
    $(function(){
                function AddCode(inname, realname){
                $.ajax({
                    async: true,
                    url: "/js/sched_task_upload_draw.php",
                    type: "POST",
                    data:{
                        "action":"add_file_entry",
                        "factname":inname,
                        "realname":realname
                    },
                    beforeSend: function(){
                          
                    },
                    success: function(data){
                      
                       $("#uploaded_files").append(data);
                       
                        
                       //перерисовать блок сообщений
                                    },
                    error: function(xhr, status){
                            
                    }	 
                });	
                
            }
            
            $('#file').uploadifive({
                    'auto'             : true,
                    'buttonText' : 'Выберите файл...',
                'fileTypeDesc' : 'Все файлы',
                'fileTypeExts' : '*.*', 
                    'fileSizeLimit' : '512 MB', 
                    'width'           : 120,
                    'formData'         : {
                                           "PHPSESSID" : "%{$session_id}%"
                                         },
                    'queueID'          : 'queue',
                    'uploadScript'     : '/swfupl-js/kp_in_upload_file.php',
                    'onUploadComplete' : function(file, data) { 
                            eval(data)
							//alert(data)
                    
                    }
                });
            
         
    });
     </script>

    
   
</div>
 
 
<br clear="all" />
 
  

 
   

<div style="float:left; width:100%; min-width:480px;  margin-right:0px; ">
 
       
    
    <div style="float:left; margin-right:20px;"> 
    <h3 style="display:inline;">Контрагент:</h3>
    </div>
     
   
    
    
    %{include file="kp_in/supplier_many_actions.html" many=false can_modify=false}%

</div>
 
 <br clear="all" />
<p />


<div style="float:left; width:100%; min-width:480px;  margin-right:0px; ">
 
       
    
    <div style="float:left; margin-right:20px;"> 
    <h3 style="display:inline;">Поставщик:</h3>
    </div>
     
   
    
    
    %{include file="kp_in/suppliertz_many_actions.html" many=false can_modify=false suppliers=$supplierstz}%

</div>
 
 <br clear="all" />
<p />
      

 
 <div style="float:left; margin-right:20px;">

	<label for="manager_select">Ответственный сотрудник:</label><br>

	<input type="hidden"  id="manager_id" name="manager_id" value="%{$manager_id}%" />
   
    <input type="text"  id="manager_string"  value="%{$manager_string|escape}%"  disabled size="40" maxlength="255" style="width:300px;" />
  

	 
	
    %{include file="lead/manager_actions.html" can_modify=false}%
    
</div> 
 
<br clear="all" />
<p />



<div style="float:left; margin-right:20px; margin-top:00px;">
    
    
     
    <label for="eq_type_id"> 
Тип оборудования:</label> <br>

  
     <select  id="eq_type_id" %{if !$can_select_eq}% disabled="disabled"%{else}% name="eq_type_id" %{/if}% style="width:300px">
        %{html_options values=$eq_ids selected=$eq_type_id output=$eq_vals}%
    </select> 
    
    %{if !$can_select_eq}%
    <input name="eq_type_id" type="hidden" value="%{$bill.eq_type_id}%" />
    %{/if}%
     
	<input type="button" value="..." %{if !$can_expand_types or !$can_select_eq}% disabled%{/if}% id="expand_types" />
    
     %{include file="kp_in/d_types_dialog.html"}%
   
    

</div>

<div style="float:left; margin-right:20px; margin-top:00px;">
	 <label for="quantity">Кол-во:</label><br>
    <input type="text" size="3"  maxlength="10" id="quantity" name="quantity" value="1" %{if !$can_select_eq}% disabled="disabled"%{/if}%  />
</div>

<div style="float:left; margin-right:20px; margin-top:00px;">
	<label for="supply_pdate_id">Срок поставки:</label><br />
    <select id="supply_pdate_id" name="supply_pdate_id" style="width:120px;"  %{if !$can_select_eq}% disabled="disabled"%{/if}% >
    %{html_options values=$supply_pdate_id_ids selected=0 output=$supply_pdate_vals}%
    </select>
</div>


<div style="float:left; margin-right:20px; margin-top:00px;">
	 <label for="cost">
 Сумма:
    </label><br />
    
    <input type="text" value="0" id="cost" name="cost"   size="10"  %{if !$can_select_eq}% disabled="disabled"%{/if}%     maxlength="512" />

    <select name="currency_id" id="currency_id" style="width:45px;"  %{if !$can_select_eq}% disabled="disabled"%{/if}%   >
    %{section name=cursec loop=$currs}%
    <option value="%{$currs[cursec].id}%" %{if $currs[cursec].id==0}% selected="selected"%{/if}%>%{$currs[cursec].signature}%</option>
    %{/section}%
    </select>
</div>

<br clear="all" />
<p />

<br>


 
 <!-- Блок разрешения утверждения -->
<input type="hidden" name="do_confirm" id="do_confirm" value="0" />
 



<input type="submit" value="Создать вход. КП" name="doNew" />


<input type="submit" name="doNewEdit"  id="doNewEdit" value="Создать вход. КП и остаться в карте" />


<input type="button" value="Отмена" name="cancelOrder" id="do_close" onclick="location.href='kps.php';" />
 

</form>


<script type="text/javascript">
var frmvalidator  = new Validator("crea_form");

function DoCustomValidation()
{

	var can_ret=true;	  
 	function doBlink(v){
		
		var blr=window.setInterval( function(){
			$(v).toggleClass("blue");	
		}, 100);
		
		window.setTimeout( function(){
			window.clearInterval(blr);
			$(v).removeClass("blue");
		}, 3000);
	}
 
    if($("input[name^=upload_file_]").length==0){
		alert("Прикрепите хотя бы один файл!");
		 
		can_ret=can_ret&&false;		
	}
	
 /*	if($("tr[id^=our_suppliertz_row_]").length==0){
			 
			res=res&&false;
			 
			error_fields.push({
				"id":"supplier_str",
				"name":"Контрагент",
				"error":"Укажите контрагента лида!"
			});			
			
		}	
		 
	*/
	
	%{if $can_select_eq}%
	  if(can_ret&&(($("#eq_type_id").val()==0)||($("#eq_type_id").val()==null)||($("#eq_type_id").val()==""))){
		  alert("Выберите тип оборудования!");
		  can_ret=can_ret&&false;	
		  $("#eq_type_id").focus();	
	  }
	  
	  if(can_ret&&(isNaN($("#quantity").val())||(parseInt($("#quantity").val())<=0))){
		  alert("Укажите корректное количество!");
		  can_ret=can_ret&&false;	
		  $("#quantity").focus();	
	  }
	  
	  if(can_ret&&(($("#supply_pdate_id").val()==0)||($("#supply_pdate_id").val()==null)||($("#supply_pdate_id").val()==undefined))){
		  alert("Укажите срок поставки!");
		  can_ret=can_ret&&false;	
		  $("#supply_pdate_id").focus();	
	  }
	  
	  if(can_ret&&(($("#currency_id").val()==0)||($("#currency_id").val()==null)||($("#currency_id").val()==undefined))){
		  alert("Укажите валюту!");
		  can_ret=can_ret&&false;	
		  $("#currency_id").focus();	
	  }
	  
	  if(can_ret&&((isNaN($("#cost").val().replace(/\,/,'')))||($("#cost").val()==0)||($("#cost").val()==null)||($("#cost").val()==undefined))){
			alert("Укажите корректную сумму!");
			can_ret=can_ret&&false;	
			$("#cost").focus();	
		}
	  %{/if}%
	
	%{if $can_confirm}% 
	if(can_ret){
		if(window.confirm("Желаете ли вы утвердить заполнение КП?")){
			$("#do_confirm").val(1);	
		}else $("#do_confirm").val(0);	
	}
	%{/if}%
	
	
	return can_ret; 
}

frmvalidator.addValidation("given_pdate","req","Укажите дату КП!");
 

 




frmvalidator.setAddnlValidationFunction(DoCustomValidation);
</script>