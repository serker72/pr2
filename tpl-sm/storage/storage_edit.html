<script type="text/javascript">
var was_changed=false;
$(function(){

	
	$.each($("#crea_form input"), function(key, value){
	 	$(value).bind("change",function(){
			was_changed=was_changed||true;
		});
	});
	
	$.each($("#crea_form select"), function(key, value){
	 	$(value).bind("change",function(){
			was_changed=was_changed||true;
		});
	});
	
	$.each($("#crea_form textarea"), function(key, value){
	 	$(value).bind("change",function(){
			was_changed=was_changed||true;
		});
	});
});
</script>
<form action="ed_storage.php" method="post" id="crea_form">
<input type="hidden" name="action" value="1" />
<input type="hidden" name="id" value="%{$storage.id}%" />


<div style="float:left; margin-right:10px;">
<label for="name">Название:</label><br />
<input type="text" size="40" maxlength="255" name="name" value="%{$storage.name|escape:"html"}%" />

</div>

%{include file="every_help_dialog.html" filename="storage_edit.htm" prefix="" description="редактирование объекта"  style="float:right; margin-top:10px;  margin-right:10px;"}%

<div style="float:right; margin-right:5px;">
<br />
<input type="button" value="Схема проезда..." onclick="location.href='storage_files.php?sup_id=%{$storage.id}%';" />
</div>
<br clear="all" />
<p />



<label for="fact_address">Фактический адрес:</label><br />
<textarea name="fact_address" id="fact_address" cols="100" rows="5">%{$storage.fact_address|escape:"html"}%</textarea>
<p />

<!--
<div style="float:left; margin-right:10px;">
<label for="nach_user_id">Начальник объекта:</label><br />
<select name="nach_user_id" style="width:200px;">
%{html_options values=$nach_user_ids selected=$storage.nach_user_id output=$nach_user_names}%
</select>
</div>

<div style="float:left; margin-right:10px;">
<label for="zamnach_user_id">Заместитель начальника объекта:</label><br />
<select name="zamnach_user_id" style="width:200px;">
%{html_options values=$zamnach_user_ids selected=$storage.zamnach_user_id output=$zamnach_user_names}%
</select>
</div>

<br clear="all" />
<p />
-->

<strong>Время работы (МСК):</strong>
<div style="float:left; margin-right:30px; white-space:nowrap;">
<label for="time_from_h_s">с:</label>
<select name="time_from_h_s" style="width:40px">
	%{html_options values=$from_hrs selected=$from_hr output=$from_hrs}%
</select>час. 
<select name="time_from_m_s" style="width:40px">
	%{html_options values=$from_ms selected=$from_m output=$from_ms}%
</select>мин.
</div>

<div style="float:left; margin-right:30px; white-space:nowrap;">
<label for="time_to_h_s">по:</label>
<select name="time_to_h_s" style="width:40px">
	%{html_options values=$to_hrs selected=$to_hr output=$to_hrs}%
</select>час. 
<select name="time_to_m_s" style="width:40px">
	%{html_options values=$to_ms selected=$to_m output=$to_ms}%
</select>мин.
</div>
<br clear="all" />
<p />


<h4>Примечания:</h4>
<div id="notes" style="border:1px solid silver; width:700px; height:100px; overflow:scroll;">
        %{include file="storage/d_notes.html" items=$notes word="notes" named="Примечания" user_id=$storage.id can_edit=$can_notes_edit}%
    </div>
    %{if $can_notes_edit}%
    %{include file="storage/d_notes_dialog.html" word="notes" named="Примечания" user_id=$storage.id can_edit=$can_notes_edit}%
    %{/if}%
<p />    



<input type="checkbox" name="is_active" id="is_active" value="1" %{if $storage.is_active==1}% checked="checked"%{/if}% %{if $can_confirm==false}% disabled="disabled"%{/if}% />
<label for="is_active">Объект активен</label><br />
<p />


<strong>Участки, работающие с объектом:</strong><br />
%{section name=rowsec loop=$storages}%
%{if $smarty.section.rowsec.index==0 or $smarty.section.rowsec.index==$div}%
<div style="float:left; margin-right:20px;">
%{/if}%

<input type="checkbox" value="1" name="sector_id_%{$storages[rowsec].id}%" %{if $storages[rowsec].is_in==1}% checked="checked"%{/if}% %{if $can_modify_ss==false}% disabled="disabled"%{/if}% /><label for="storage_id_%{$storages[rowsec].id}%" %{if $storages[rowsec].is_active==0}% class="item_inactive"%{/if}%>%{$storages[rowsec].name}%</label><br />
%{if $smarty.section.rowsec.last or $smarty.section.rowsec.index_next==$div}%
</div>
%{/if}%
%{/section}%
<br clear="all" />
<p />


<input type="checkbox" value="1" name="post_hran" %{if $can_post_hran==false}% disabled="disabled"%{/if}% %{if $storage.post_hran==1}% checked="checked"%{/if}%  /><label for="post_hran">Объект постоянного хранения</label>
<br />


<strong><span style="color:red;">Внимание! При установке поля "Объект постоянного хранения" сотрудники, имеющие соответствующие права, смогут работать с документами по всем участкам данного объекта!</span></strong>

<br />

<div style="float:right;">
<input type="checkbox" value="1" name="s_s" %{if $storage.s_s==1}% checked="checked"%{/if}% %{if $can_s_s==false}% disabled="disabled"%{/if}% /><label for="s_s" >S/S</label>
</div>


<br clear="all" />
<p />



%{if $can_edit}%
<input type="submit" name="doEdit" value="Сохранить и перейти к списку объектов" />
<input type="submit" name="doEditStay" value="Сохранить и остаться" />
%{/if}%

<input type="button" id="do_close" value="Закрыть форму" onclick="if(was_changed){
if(window.confirm('Вы уверены, что хотите закрыть форму? Все несохраненные изменения будут утрачены.')) location.href='storage.php';
}else location.href='storage.php';" />


</form>


<div id="non_unconfirm_dialog" title="Невозможно снять активность объекта">
    <strong>Невозможно снять активность объекта %{$storage.name}%.</strong><br />
	<br />

    На данном объекте находятся товарные остатки. Для того, чтобы снять активность объекта,
    необходимо списать все товарные остатки по нему.<br />
<br />
	
    Для того, чтобы выяснить, какие товарные остатки находятся на данном объекте, Вы можете воспользоваться 
    отчетом <a href="goods_on_stor.php" target="_blank">"Товары на объектах"</a>.
<br />
<br />
    
    Для списания остатков Вы можете создать акт списания в разделе <a href="writeoff.php" target="_blank">"Списание продукции"</a> при наличии у Вас соответствующих прав.
      
 </div>

<script type="text/javascript">
$(function(){
	$("#non_unconfirm_dialog").dialog({
			autoOpen: false,
			modal: true,
			width: 550,
			height: 250,
			stack: true,
			buttons:{
				"ОК":function(){
					$(this).dialog("close");
				}
			}
		});
	
	
	$("#crea_form").bind("submit",function(){
		var res=true;
		
		%{if $storage.is_active==0}%
		if($("#is_active").prop("checked")){
			if($("#fact_address").val().replace(/[\.,!\?\-_\#\*\+]+/g, '').length<10){
				res=false;
				alert("Для утверждения объекта заполните поле Фактический адрес!");
				$("#is_active").prop("checked",false);
				$("#fact_address").focus();
			}
			
		}
		%{/if}%
		
		%{if $storage.is_active==1}%
		if(!$("#is_active").prop("checked")){
			$.ajax({
				async: false,
				url: "/js/ed_storage.php",
				type: "POST",
				data:{
					"action":"check_unconfirm",
					id: "%{$storage.id}%"
				},
				beforeSend: function(){
					  
				},
				success: function(data){
				  if(data!=0){
					
					 $("#non_unconfirm_dialog").dialog("open");
					 
					 res=false;
					 
				  }else{
					//запросить док-ты на ав, аа, вывести их список
					$.ajax({
					  async: false,
					  url: "/js/ed_storage.php",
					  type: "POST",
					  data:{
						  "action":"check_unconfirm_by_docs",
						  id: "%{$storage.id}%"
					  },
					  beforeSend: function(){
							
					  },
					  success: function(data){
						//  alert(data); res=false;	
						  if(data!=""){ 
							if(window.confirm("Внимание!\nПо данному объекту есть документы с неполным завозом и без завоза.\nПри снятии флага Объект активен документы без завоза будут автоматически аннулированы, документы с неполным завозом - автоматически выровнены.\n"+data+"\nВы уверены?")){
								res=window.confirm("Вы уверены?");
							}else res=false;
						  }
					  },
					  error: function(xhr, status){
						  
						  alert("Ошибка при проверке состояния объекта. Пожалуйста, попытайтесь сохранить объект снова.");
						  res=false;	
					  }	 
				  });	  
					  
				  }
				},
				error: function(xhr, status){
					
					alert("Ошибка при проверке состояния объекта. Пожалуйста, попытайтесь сохранить объект снова.");
					res=false;	
				}	 
			});
		}
		%{/if}%
		
		
		return res;
	});
});
</script>