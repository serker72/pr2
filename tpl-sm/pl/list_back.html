<script type="text/javascript">
$(function(){
	$(".reptable").columnHover();
	/*$(".reptable tr:even").addClass("even");*/
	
});
</script>





<form action="%{$pagename}%" method="get" id="filter_form%{$prefix}%">
<input type="hidden" name="from%{$prefix}%" value="0" />
<input type="hidden" name="to_page%{$prefix}%" value="%{$to_page}%" />
<input type="hidden" name="sortmode%{$prefix}%" value="%{$sortmode}%" />


%{section name=rowsec loop=$items}%%{/section}%


<!--выбор группы I-->
<input type="hidden" name="group_id%{$prefix}%" id="group_id%{$prefix}%" value="%{$group_id}%" />
 %{section name=groupsec loop=$group}%
   <a href="%{$pagename}%?group_id%{$prefix}%=%{$group[groupsec].id}%" class="pl_button%{if $group[groupsec].is_current}%_pressed%{/if}%">%{$group[groupsec].name|escape:"html"}%</a>
 %{/section}%


%{include file="every_help_dialog.html" filename="pricelist.htm" prefix="" description="Раздел Прайс-лист" style="float:right;  margin-right:10px;"}%

<br clear="all" />

<p />

%{$pages}%


<!--выбор ПРОИЗВОДИТЕЛЯ-->
<div style="float:left; margin-right:10px;">
	<label for="producer_id%{$prefix}%">Производитель:</label>
 	<select name="producer_id%{$prefix}%" id="producer_id%{$prefix}%" style="width:200px;">
    %{section name=prodsec loop=$producers}%
    	<option value="%{$producers[prodsec].id}%" %{if $producers[prodsec].is_current}%selected="selected"%{/if}%>%{$producers[prodsec].name|escape:"html"}%</option>
    %{/section}%
    </select>

</div>

<!--выбор группы II-->
<div style="float:left; margin-right:10px;">
	<label for="two_group_id%{$prefix}%">Категория:</label>
    
    <select name="two_group_id%{$prefix}%" id="group_id2%{$prefix}%" style="width:200px;">
    %{section name=two_groupsec loop=$two_group}%
    	<option value="%{$two_group[two_groupsec].id}%" %{if $two_group[two_groupsec].is_current}%selected="selected"%{/if}%>%{$two_group[two_groupsec].name|escape:"html"}%</option>
    %{/section}%
    </select>

</div>



<script type="text/javascript">
	$(function(){
		
		
		$("#group_id2%{$prefix}%").bind("change", function(){
			
			can_go=true;
			
			if(can_go) if(($("#group_id%{$prefix}%").val()==0)||($("#group_id%{$prefix}%").val()==undefined)){
				alert("Выберите раздел прайс-листа!");
				$("#group_id%{$prefix}%").focus(); 
				can_go=can_go&&false;
			}
			
			
			if(can_go) if(($("#producer_id%{$prefix}%").val()==0)||($("#producer_id%{$prefix}%").val()==undefined)){
				alert("Выберите производителя!");
				$("#producer_id%{$prefix}%").focus();
				can_go=can_go&&false;
			}
			
			if(can_go) if(($("#group_id2%{$prefix}%").val()==0)||($("#group_id2%{$prefix}%").val()==undefined)){
				alert("Выберите категорию!");
				$("#group_id2%{$prefix}%").focus(); 
				 can_go=can_go&&false;
				 
			}
			
			
			
			if(can_go)  location.href='%{$pagename}%?group_id%{$prefix}%='+$("#group_id%{$prefix}%").val()+'&two_group_id%{$prefix}%='+$("#group_id2%{$prefix}%").val()+'&producer_id%{$prefix}%='+$("#producer_id%{$prefix}%").val();
		});
	});
	</script>


<br clear="all" />
<p />


%{if $can_add}%
<input type="button" value="Добавить позицию..." id="pl_add_button" />
<script type="text/javascript">
$(function(){
	$("#pl_add_button").bind("click", function(){
		
		can_go=true;
			
		if(can_go) if(($("#group_id%{$prefix}%").val()==0)||($("#group_id%{$prefix}%").val()==undefined)){
			alert("Выберите раздел прайс-листа!");
			$("#group_id%{$prefix}%").focus(); 
			can_go=can_go&&false;
		}
		
		
		if(can_go) if(($("#producer_id%{$prefix}%").val()==0)||($("#producer_id%{$prefix}%").val()==undefined)){
			alert("Выберите производителя!");
			$("#producer_id%{$prefix}%").focus();
			can_go=can_go&&false;
		}
		
		if(can_go) if(($("#group_id2%{$prefix}%").val()==0)||($("#group_id2%{$prefix}%").val()==undefined)){
			alert("Выберите категорию!");
			$("#group_id2%{$prefix}%").focus(); 
			can_go=can_go&&false;
			 
		}
		
		if(can_go) location.href='ed_pl_position.php?action=0&group_id='+$("#group_id%{$prefix}%").val()+'&group_id2='+$("#group_id2%{$prefix}%").val()+'&producer_id='+$("#producer_id%{$prefix}%").val();
		
		return false;
	});
});
</script>
%{/if}%




<table width="100%" border="0" cellpadding="2" cellspacing="0" class="reptable">
<thead>
<tr align="center" valign="top" class="equip">
	<th scope="col" width="40">
   №
   
    <div class="sort_dir">
    <a href="%{$link}%&sortmode%{$prefix}%=5"><img src="/img/up.gif" border="0" alt="" width="11" height="16" /></a>
    <a href="%{$link}%&sortmode%{$prefix}%=4"><img src="/img/down.gif" border="0" alt="" width="11" height="16" /></a>
    </div>
    </th>
    
    
    
    <th scope="col" width="40">
    Код позиции
    <div class="sort_dir">
    <a href="%{$link}%&sortmode%{$prefix}%=1"><img src="/img/up.gif" border="0" alt="" width="11" height="16" /></a>
    <a href="%{$link}%&sortmode%{$prefix}%=0"><img src="/img/down.gif" border="0" alt="" width="11" height="16" /></a>
    </div>
    </th>
    
  
    <th scope="col" width="*" style="min-width:150px;">
    Наименование
    <div class="sort_dir">
    <a href="%{$link}%&sortmode%{$prefix}%=3"><img src="/img/up.gif" border="0" alt="" width="11" height="16" /></a>
    <a href="%{$link}%&sortmode%{$prefix}%=2"><img src="/img/down.gif" border="0" alt="" width="11" height="16" /></a>
    </div>
    </th>
    
     <th width="30" scope="col">
    ед. изм.
   
    </th>
    
     <th scope="col" width="80">
   Производитель
   
    </th>
    
   <th scope="col" width="80">
   Раздел/ категория
   
    </th>
    
     <th width="30" scope="col">
    Кол-во
    </th>
   
   	 <th width="50" scope="col">
    Цена 
   
    </th>
    
    
    %{section name=discssec loop=$discs}%
     <th width="40" scope="col">
    %{$discs[discssec].name}%
   
    </th>
    %{/section}%
    
    
  
    
    <th width="50" scope="col">
    Итоговая цена 
   
    </th>
    
    <th scope="col" width="40">
    Файлы
    </th>
    <th width="24" scope="col">
     %{if $can_create_bill}%
       <a href="#" id="makeBill%{$prefix}%"><img src="/img/icons/new-outcoming.png" width="24" height="24" title="создать исходящий счет" alt="создать исходящий счет" border="0" /></a> 
       <script type="text/javascript">
	  $(function(){
		$("#makeBill%{$prefix}%").bind("click", function(){
			if($("input[id^=do_update_]:checked").length==0){
					alert("Выделите позиции для создания исходящего счета!");	
					return false;
			}
			var url=''; var is_correct=true;
			$("input[id^=do_update_]:checked").each(function(index, el) {
			
				quantity=$("#quantity"+$(el).val()+"%{$prefix}%").val();
				
				quantity=quantity.replace(/,/,'.');
				if((quantity.length==0)||(isNaN(quantity))||(parseFloat(quantity)<=0)){
					alert("Введите корректное значение в поле Количество!");
					$("#quantity"+$(el).val()+"%{$prefix}%").focus();
					 
					 is_correct= is_correct&&false;
				}
				url=url+'&pl_position_id[]='+$(el).val()+';'+quantity;
			});
			
			if(is_correct) location.href="ed_bill.php?action=0&from_begin=1"+url;
			
			return false;
		});
	  });
	  </script>
       %{else}%
     <a href="#" id="makeBill%{$prefix}%" onclick="alert('У Вас недостаточно прав для создания исходящего счета!'); return false;"><img src="/img/icons/new-outcoming-gr.png" width="24" height="24" title="создать исходящий счет" alt="создать исходящий счет" border="0" /></a>
     %{/if}%
     
     <br />

      %{if $can_create_incoming_bill}%
       <a href="#" id="makeInBill%{$prefix}%"><img src="/img/icons/new-incoming.png" width="24" height="24" title="создать входящий счет" alt="создать входящий счет" border="0" /></a> 
       <script type="text/javascript">
	  $(function(){
		$("#makeInBill%{$prefix}%").bind("click", function(){
			if($("input[id^=do_update_]:checked").length==0){
					alert("Выделите позиции для создания входящего счета!");	
					return false;
			}
			var url=''; var is_correct=true;
			$("input[id^=do_update_]:checked").each(function(index, el) {
			
				quantity=$("#quantity"+$(el).val()+"%{$prefix}%").val();
				
				quantity=quantity.replace(/,/,'.');
				if((quantity.length==0)||(isNaN(quantity))||(parseFloat(quantity)<=0)){
					alert("Введите корректное значение в поле Количество!");
					$("#quantity"+$(el).val()+"%{$prefix}%").focus();
					 
					 is_correct= is_correct&&false;
				}
				url=url+'&pl_position_id[]='+$(el).val()+';'+quantity;
			});
			
			if(is_correct) location.href="ed_bill_in.php?action=0&from_begin=1"+url;
			
			return false;
		});
	  });
	  </script>
       %{else}%
     <a href="#" id="makeBill%{$prefix}%" onclick="alert('У Вас недостаточно прав для создания входящего счета!'); return false;"><img src="/img/icons/new-incoming-gr.png" width="24" height="24" title="создать входящий счет" alt="создать входящий счет" border="0" /></a>
     %{/if}%
     </th>
    
   
    
    
     <th scope="col" width="24">
     
     %{if $can_edit}%
      <a href="#" id="saveSelected%{$prefix}%"><img src="/img/icons/save.png" width="24" height="24" title="Сохранить изменения в выбранных позициях" alt="Сохранить изменения в выбранных позициях" border="0" /></a>
      <script type="text/javascript">
	  $(function(){
		$("#saveSelected%{$prefix}%").bind("click", function(){
			
			if($("input[id^=do_update_]:checked").length==0){
				alert("Выделите позиции для редактирования!");	
				return false;
			}
			
			if(window.confirm("Вы действительно хотите внести изменения в выбранные позиции прайс-листа?")){
			
				//changing ajax
				var checked_ids=new Array();
				var strs=new Array();
				var price=new Array();
				var currency_id=new Array();
				
				
				var discount_id=new Array();
				var discount_value=new Array();
				var discount_rub_or_percent=new Array();
				
				var dl_value=new Array();
				var dl_rub_or_percent=new Array();
				
			
				var res=true;
				$("input[id^=do_update_]:checked").each(function(index, el) {
                 	res=res&&IsCorrectMaxSk%{$prefix}%($(el).val());
					if(res) res=res&&IsCorrectSk%{$prefix}%($(el).val());
				   	if(res) res=res&&IsCorrectBounds%{$prefix}%($(el).val());
				   	if(res) res=res&&RecalcPrice%{$prefix}%($(el).val());
				 
				});
				if(!res){
					return false;	
					
				}
				
				
				$("input[id^=do_update_]:checked").each(function(index, el) {
                    
					
					checked_ids.push($(el).val());
					id=$(el).val();
					
					price.push($("#price"+id+"%{$prefix}%").val());
					
					currency_id.push($("#currency_id_"+id+"%{$prefix}%").val());
					
					
					//перебрать данные для всех скидок. какая ненулевая и есть ли такая - определить серверный скрипт
					discount_id_1=new Array();
					discount_value_1=new Array();
					discount_rub_or_percent_1=new Array();
					
					dl_value_1=new Array();
					dl_rub_or_percent_1=new Array();
					
					
					%{foreach from=$discs item=discs1}%
					discount_id_1.push("%{$discs1.id}%");
					discount_value_1.push($("#discount_%{$discs1.id}%_"+id+"%{$prefix}%").val().replace("\,","\.")); 
					discount_rub_or_percent_1.push($("#discount_rub_or_percent_%{$discs1.id}%_"+id+"%{$prefix}%").val().replace("\,","\.")); 
					
					dl_value_1.push($("#dl_value_%{$discs1.id}%_"+id+"%{$prefix}%").val().replace("\,","\.")); 
					dl_rub_or_percent_1.push($("#dl_rub_or_percent_%{$discs1.id}%_"+id+"%{$prefix}%").val().replace("\,","\.")); 
					 
					%{/foreach}%
					
					discount_id.push(discount_id_1);
					discount_value.push(discount_value_1);
					discount_rub_or_percent.push(discount_rub_or_percent_1);
					
					dl_value.push(dl_value_1);
					dl_rub_or_percent.push(dl_rub_or_percent_1);
					
						
                });
				
				//alert(currency_id); return false;
				
				
				
				$.ajax({
					async: true,
					url: "/js/pricelist.php",
					type: "POST",
					data:{
						"action":"edit_items",
						"checked_ids[]":checked_ids,
						"price[]":price,
						"currency_id[]":currency_id,
						"discount_id[]":discount_id,
						"discount_value[]":discount_value,
						"discount_rub_or_percent[]":discount_rub_or_percent,
						"dl_value[]":dl_value,
						"dl_rub_or_percent[]":dl_rub_or_percent
						
											},
					beforeSend: function(){
						  
					},
					success: function(data){
					  //alert(data);
					  location.reload();
					  //$("#group_id3%{$prefix}%").html('<option value=""></option>'+data);
					  
					},
					error: function(xhr, status){
						//alert("Ошибка выбора подгрупп.");	
					}	 
				});
			}
			return false;
		});
	  });
	  </script>
     %{/if}%
     
     
     </th>
    <th scope="col" width="24">&nbsp;</th>
   
   
</tr>
<tr align="center" valign="top" class="equip">
	<td width="40">
	 <input type="text" size="4" maxlength="255" value="%{$id}%" name="id%{$prefix}%" id="id%{$prefix}%" style="width:40px;" />
    
    </td>
    
    <td width="40">
	 <input type="text" size="4" maxlength="255" value="%{$code}%" name="code%{$prefix}%" id="code%{$prefix}%" style="width:40px;" />
    
    </td>
    
   
	<td width="*" style="min-width:150px;" >
   <input type="text" size="10" maxlength="255" value="%{$name}%" name="name%{$prefix}%" id="name%{$prefix}%"  />
    
    </td>
    
     <td  width="30">
    <select name="dimension_id%{$prefix}%" id="dimension_id%{$prefix}%" style="width:30px;">
    %{section name=dimsec loop=$dim}%
    	<option value="%{$dim[dimsec].id}%" %{if $dim[dimsec].is_current}%selected="selected"%{/if}%>%{$dim[dimsec].name|escape:"html"}%</option>
    %{/section}%
    </select>
    
    </td>
    
     <td width="80">
     
       <input type="text" size="5" maxlength="255" value="%{$producer_name}%" name="producer_name%{$prefix}%" id="producer_name%{$prefix}%" />
    </td>
    
    
    <td width="80">
    </td>
    
    
     <td width="30">
     
     </td>
    
     <td width="50">
   
   
    </td>
    
    %{section name=discssec loop=$discs}%
   <td width="40"></td>
    %{/section}%
    
    
    <td width="40"></td>
    
     
    
     
    <td width="24">&nbsp;
    
   
    </td>
    
     <td width="24">
    <input type="checkbox" id="selectAll%{$prefix}%" %{if !$can_edit and !$can_create_bill}% disabled="disabled"%{/if}%  />
   <script type="text/javascript">
   $(function(){
	  $("#selectAll%{$prefix}%").bind("change", function(){
		 $("input[type=checkbox][id^=do_update_]").prop('checked', $(this).prop("checked"));
	  });
   });
   </script>
    </td>
   
   
    <td width="24">
    <input name="doFilter%{$prefix}%" type="image" src="/img/icons/old-zoom-original.png" alt="Найти" />
    </td>
    
     <td width="24"></td>
  
</tr>
</thead>
<tbody>
%{section name=rowsec loop=$items}%
<tr align="center" valign="top" class="equip">
	
   
   <td width="40"><a name="#user_%{$option.pl_id}%%{$prefix}%"></a>%{$items[rowsec].pl_id}%</td>
   
    <td width="40"> %{$items[rowsec].code}%</td>
   
   
    <td width="*"  style="min-width:150px;">
    
    %{$items[rowsec].name}%
    
    
    </td>
    <td width="30">%{$items[rowsec].dim_name}%</td>
    
    <td width="80">%{$items[rowsec].producer_name}%</td>
   
    <td width="80">%{$items[rowsec].group_name}%</td>
   
    
    <td width="30">
   <input type="text" size="7" maxlength="255" value="0" id="quantity%{$items[rowsec].pl_id}%%{$prefix}%" style="width:30px;" />
    </td>
    
   
    <td width="50" style="white-space:nowrap;">
    <input type="text" size="7" maxlength="255" value="%{$items[rowsec].price}%" name="price%{$items[rowsec].pl_id}%%{$prefix}%" id="price%{$items[rowsec].pl_id}%%{$prefix}%" %{if !$can_edit}% disabled="disabled"%{/if}% />
    
    
    <select name="currency_id_%{$items[rowsec].pl_id}%%{$prefix}%" id="currency_id_%{$items[rowsec].pl_id}%%{$prefix}%" style="width:45px;" %{if !$can_edit}% disabled="disabled"%{/if}%>
    %{foreach from=$currencies item=currency}%
     <option value="%{$currency.id}%" %{if $items[rowsec].currency_id==$currency.id or ($items[rowsec].currency_id==false and $currency.id==2)}% selected="selected"%{/if}% >%{$currency.signature}%</option>
    %{/foreach}%
    </select>
   
    <input type="hidden" value="0" id="price_was_changed%{$items[rowsec].pl_id}%%{$prefix}%" />
  <input type="hidden" value="%{$items[rowsec].currency_id}%" id="old_currency_id_%{$items[rowsec].pl_id}%%{$prefix}%" />
  
    </td>
    
    
    
    
    %{foreach from=$items[rowsec].discs1 item=discs1}%
	<td width="40" style="white-space:nowrap;" align="left">
    
    %{if $items[rowsec].discount_id==$discs1.id}%
      <input type="text" size="4" maxlength="255" value="%{$items[rowsec].discount_value}%" name="discount_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%" id="discount_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%" %{if !$can_edit}% disabled="disabled"%{/if}% />
     
   
  
    %{else}%
      <input type="text" size="4" maxlength="255" value="0.00" name="discount_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%" id="discount_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%" %{if !$can_edit}% disabled="disabled"%{/if}% />
    
      
    %{/if}%
    %
    
    <input type="hidden" id="discount_rub_or_percent_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%" name="discount_rub_or_percent_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%" value="1" />
    
    
    
    %{if $can_max_val}%
      <!-- ecли есть ограничения, нужно их также выписать -->
      <br />
      Макс. скидка:<br />
  
      <input type="text" size="4" maxlength="255" value="%{$discs1.dl_value}%" name="dl_value_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%" id="dl_value_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%" %{if !$can_edit}% disabled="disabled"%{/if}% />
     
    %{else}%
      
      <input type="hidden" value="%{$discs1.dl_value}%" name="dl_value_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%" id="dl_value_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%" />
    
      
    %{/if}%
    %
    
     <input type="hidden" value="1" name="dl_rub_or_percent_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%" id="dl_rub_or_percent_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%" />
    
    
    <input type="hidden" value="%{$discs1.id}%" name="dl_discount_id_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%" id="dl_discount_id_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%" />
     
    </td>
    %{/foreach}%
    
    
   
   
    <td width="50" style="white-space:nowrap;" >
   
   
   <span id="price_f%{$items[rowsec].pl_id}%%{$prefix}%">%{$items[rowsec].price_f}%</span>
    <span id="signature%{$items[rowsec].pl_id}%%{$prefix}%">%{$items[rowsec].signature}%</span>
   
   
   
    </td>
   
   
  
  
     <td width="40">
      <a href="pos_files.php?bill_id=%{$items[rowsec].pl_id}%" target="_blank"><img src="/img/files.png" width="47" height="25" alt="Файлы" border="0" /></a></td>
                        
        <td width="24">
     <input type="checkbox" id="do_update_%{$items[rowsec].pl_id}%%{$prefix}%" %{if !$can_edit  and !$can_create_bill}% disabled="disabled"%{/if}% value="%{$items[rowsec].pl_id}%"  />
     </td>
                        
                        
                        
    <td width="24">
    %{if $can_edit}%
   
    <a href="ed_pl_position.php?action=1&id=%{$items[rowsec].id}%" target="_blank"><img src="/img/icons/edit.png" width="24" height="24" alt="карточка товара в номенклатуре..." title="карточка товара в номенклатуре..." border="0" /></a>
    
    %{/if}%
    </td>
    
    <td width="24">
    %{if $can_delete}%
    
    %{if $items[rowsec].can_delete}%
    <a href="#" onclick="if(window.confirm('Вы действительно хотите удалить позицию прайс-листа %{$items[rowsec].name|escape}%?')) location.href='pricelist.php?action=2&id=%{$items[rowsec].pl_id}%'; return false;">
    %{/if}%
    <img src="/img/icons/delete%{if $items[rowsec].can_delete==false}%_inactive%{/if}%.png" width="24" height="24" alt="удалить..." title="удалить..." border="0" />
    %{if $items[rowsec].can_delete}%
    </a>
    %{/if}%
    
   
    %{/if}%
    </td>
</tr>
<!-- опции -->
%{foreach from=$items[rowsec].options item=option}%
<!-- ряды опций -->
%{if $option.kind=="group"}%
<!-- группа опций -->
<tr align="center" valign="top" class="equip_optgr">
	<td colspan="15"><strong>%{$option.name}%</strong></td>
</tr>
%{else}%
<!-- опция -->
<tr align="center" valign="top">
	<td width="40"><a name="#user_%{$option.pl_id}%%{$prefix}%"></a>%{$option.pl_id}%</td>
   
    
    <td width="40"> %{$option.code}%</td>
   
   
    <td width="*"  style="min-width:150px;"> 
    
   
    
    <div align="left" id="txt_for_kp_small_%{$option.pl_id}%%{$prefix}%">
    
    %{$option.name|strip_tags|truncate:50:false}%
    <a href="#" onclick="$('#txt_for_kp_full_%{$option.pl_id}%%{$prefix}%').show(); $('#txt_for_kp_small_%{$option.pl_id}%%{$prefix}%').hide(); return false;">...
    </a>
    </div> 
    
    <div align="left" id="txt_for_kp_full_%{$option.pl_id}%%{$prefix}%" style="display:none;">
    %{$option.name}% 
    
    <a href="#" onclick="$('#txt_for_kp_full_%{$option.pl_id}%%{$prefix}%').hide(); $('#txt_for_kp_small_%{$option.pl_id}%%{$prefix}%').show(); return false;">свернуть
    </a>
    </div> 
    
    
        
    
    </td>
    <td width="30">%{$option.dim_name}%</td>
    
    <td width="80">%{$option.producer_name}%</td>
   
    <td width="80">%{$option.group_name}%</td>
   
    
    <td width="30">
   <input type="text" size="7" maxlength="255" value="0" id="quantity%{$option.pl_id}%%{$prefix}%" style="width:30px;" />
    </td>
    
   
    <td width="50"  style="white-space:nowrap;">
    <input type="text" size="7" maxlength="255" value="%{$option.price}%" name="price%{$option.pl_id}%%{$prefix}%" id="price%{$option.pl_id}%%{$prefix}%" %{if !$can_edit}% disabled="disabled"%{/if}% />
   
   
  	<select name="currency_id_%{$option.pl_id}%%{$prefix}%" id="currency_id_%{$option.pl_id}%%{$prefix}%" style="width:45px;" %{if !$can_edit}% disabled="disabled"%{/if}%>
    %{foreach from=$currencies item=currency}%
     <option value="%{$currency.id}%" %{if $option.currency_id==$currency.id or ($option.currency_id==false and $currency.id==2)}% selected="selected"%{/if}% >%{$currency.signature}%</option>
    %{/foreach}%
    </select>
   
  	
    <input type="hidden" value="0" id="price_was_changed%{$items[rowsec].pl_id}%%{$prefix}%" />
    <input type="hidden" value="%{$option.currency_id}%" id="old_currency_id_%{$option.pl_id}%%{$prefix}%" />
  
    
  
    </td>
    
    
    
    
    %{foreach from=$option.discs1 item=discs1}%
	<td width="40" style="white-space:nowrap;" align="left">
    
    %{if $option.discount_id==$discs1.id}%
    <input type="text" size="4" maxlength="255" value="%{$option.discount_value}%" name="discount_%{$discs1.id}%_%{$option.pl_id}%%{$prefix}%" id="discount_%{$discs1.id}%_%{$option.pl_id}%%{$prefix}%" %{if !$can_edit}% disabled="disabled"%{/if}% />
    
    %{else}%
    <input type="text" size="4" maxlength="255" value="0.00" name="discount_%{$discs1.id}%_%{$option.pl_id}%%{$prefix}%" id="discount_%{$discs1.id}%_%{$option.pl_id}%%{$prefix}%" %{if !$can_edit}% disabled="disabled"%{/if}% />
  
    %{/if}%
    %
    
    <input type="hidden" id="discount_rub_or_percent_%{$discs1.id}%_%{$option.pl_id}%%{$prefix}%" name="discount_rub_or_percent_%{$discs1.id}%_%{$option.pl_id}%%{$prefix}%" value="1" />
    
    
    
    
    %{if $can_max_val}%
    <!-- ecли есть ограничения, нужно их также выписать -->
    <br />
    Макс. скидка:<br />

	<input type="text" size="4" maxlength="255" value="%{$discs1.dl_value}%" name="dl_value_%{$discs1.id}%_%{$option.pl_id}%%{$prefix}%" id="dl_value_%{$discs1.id}%_%{$option.pl_id}%%{$prefix}%" %{if !$can_edit}% disabled="disabled"%{/if}% />
    
     
    
    %{else}%
    
    <input type="hidden" value="%{$discs1.dl_value}%" name="dl_value_%{$discs1.id}%_%{$option.pl_id}%%{$prefix}%" id="dl_value_%{$discs1.id}%_%{$option.pl_id}%%{$prefix}%" />
    
   
    
    %{/if}%
    %
    
     <input type="hidden" value="1" name="dl_rub_or_percent_%{$discs1.id}%_%{$option.pl_id}%%{$prefix}%" id="dl_rub_or_percent_%{$discs1.id}%_%{$option.pl_id}%%{$prefix}%" />
    
    
    <input type="hidden" value="%{$discs1.id}%" name="dl_discount_id_%{$discs1.id}%_%{$option.pl_id}%%{$prefix}%" id="dl_discount_id_%{$discs1.id}%_%{$option.pl_id}%%{$prefix}%" />
     
    </td>
    %{/foreach}%
    
    
   
   
    <td width="50" style="white-space:nowrap;" >
   
   
   <span id="price_f%{$option.pl_id}%%{$prefix}%">%{$option.price_f}%</span>
   
   <span id="signature%{$option.pl_id}%%{$prefix}%">%{$option.signature}%</span>
    </td>
   
   
  
  
     <td width="40">
      <a href="pos_files.php?bill_id=%{$option.pl_id}%" target="_blank"><img src="/img/files.png" width="47" height="25" alt="Файлы" border="0" /></a></td>
                        
        <td width="24">
     <input type="checkbox" id="do_update_%{$option.pl_id}%%{$prefix}%" %{if !$can_edit  and !$can_create_bill}% disabled="disabled"%{/if}% value="%{$option.pl_id}%"  />
     </td>
                        
                        
                        
    <td width="24">
    %{if $can_edit}%
   
    <a href="ed_pl_position.php?action=1&id=%{$option.id}%" target="_blank"><img src="/img/icons/edit.png" width="24" height="24" alt="карточка товара в номенклатуре..." title="карточка товара в номенклатуре..." border="0" /></a>
    
    %{/if}%
    </td>
    
    <td width="24">
    %{if $can_delete}%
    
    %{if $option.can_delete}%
    <a href="#" onclick="if(window.confirm('Вы действительно хотите удалить позицию прайс-листа %{$option.name|escape}%?')) location.href='pricelist.php?action=2&id=%{$option.pl_id}%'; return false;">
    %{/if}%
    <img src="/img/icons/delete%{if $option.can_delete==false}%_inactive%{/if}%.png" width="24" height="24" alt="удалить..." title="удалить..." border="0" />
    %{if $option.can_delete}%
    </a>
    %{/if}%
    
   
    %{/if}%
    </td>
</tr>
%{/if}%
<!-- нужен обработчик для опций -->
%{/foreach}%
%{/section}%
</tbody>
</table>


<script type="text/javascript">
function roundPlus(x, n) { //x - число, n - количество знаков
  if(isNaN(x) || isNaN(n)) return false;
  var m = Math.pow(10,n);
  return Math.round(x*m)/m;
}

%{if $can_edit}%


/*вводимая скидка:
а) не должна превышать максимальную
б) обнуляет все другие скидки
в) пересчитывает итоговую цену
*/

//перерасчет цены (без проверки корр-ти)
function RecalcPrice%{$prefix}%(id){
	res=true;
	
	
	sum=$("#price"+id+"%{$prefix}%").val();	
	sum=sum.replace("\,","\.");
	if((sum.length>0)&&!isNaN(sum)) sum=parseFloat(sum);
	else sum=0;
	
	skidka=0;
	
	mode='';
	//найти любую скидку не нулевую
	%{section name=discssec loop=$discs}%
	sk=$("#discount_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").val();	
	sk=sk.replace("\,","\.");
	if((sk!="")&&!isNaN(sk)&&(parseFloat(sk)>0)){
		 skidka=parseFloat(sk);
		 mode="%{$discs[discssec].id}%";
	}
	%{/section}%
	
	if(mode!=""){
		if($("#discount_rub_or_percent_"+mode+"_"+id+"%{$prefix}%").val()==1){
			sum=roundPlus(parseFloat(sum)-parseFloat(sum)*parseFloat(skidka)/100,2);	
		}else{
			sum=roundPlus(parseFloat(sum)-parseFloat(skidka),2);
		}
	}
	
	$("#price_f"+id+"%{$prefix}%").text(sum);
	
	$("#signature"+id+"%{$prefix}%").text($("#currency_id_"+id+"%{$prefix}% option:selected").html());
	
	
	return res;
}



//проверка корр-ти макс. скидки (любой)
function IsCorrectMaxSk%{$prefix}%(id){
	res=true;

	
	%{section name=discssec loop=$discs}%
	
	
	local_res=true;
	sk=$("#dl_value_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").val();	
	sk=sk.replace("\,","\.");
	if((sk!="")&&(isNaN(sk)||(parseFloat(sk)<0))){
		res=res&&false;
		local_res=local_res&&false;	
		$("#dl_value_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").focus();
		alert("Некорректно заполнено максимальное значение поля %{$discs[discssec].name}%!");
		
		$("#dl_value_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").addClass("wrong");
		
	}else $("#dl_value_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").removeClass("wrong");
	
	
	//если выбраны ПРОЦЕНТЫ: то не более 99.99 процентов
	if(local_res){
	  if((sk!="")&&!isNaN(sk)&&($("#dl_rub_or_percent_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").val()==1)&&(parseFloat(sk)>99.99)){		
	  		res=res&&false;
			local_res=local_res&&false;	
			$("#dl_value_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").focus();
			alert("Некорректно заполнено максимальное значение поля %{$discs[discssec].name}%!");
			
			$("#dl_value_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").addClass("wrong");
			
	  }else $("#dl_value_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").removeClass("wrong");
	
	}
	
	
	
	%{/section}%
	
	return res;
}


//проверка корр-ти скидки (любой)
function IsCorrectSk%{$prefix}%(id){
	res=true;

	
	%{section name=discssec loop=$discs}%
	
	local_res=true;
	sk=$("#discount_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").val();	
	sk=sk.replace("\,","\.");
	if((sk=="")||isNaN(sk)||(parseFloat(sk)<0)){
		res=res&&false;
		local_res=local_res&&false;	
		$("#discount_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").focus();
		alert("Некорректно заполнено значение поля %{$discs[discssec].name}%!");
		
		$("#discount_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").addClass("wrong");
		
	}else $("#discount_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").removeClass("wrong");
	
	
	//если выбраны ПРОЦЕНТЫ: то не более 99.99 процентов
	if(local_res){
	  if(!isNaN(sk)&&($("#discount_rub_or_percent_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").val()==1)&&(parseFloat(sk)>99.99)){		
	  		res=res&&false;
			local_res=local_res&&false;	
			$("#discount_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").focus();
			alert("Некорректно заполнено максимальное значение поля %{$discs[discssec].name}%!");
			
			$("#discount_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").addClass("wrong");
			
	  }else $("#discount_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").removeClass("wrong");
	
	}
	
	if(local_res){
		
		
		sum=$("#price"+id+"%{$prefix}%").val();	
		sum=sum.replace("\,","\.");
		sum=parseFloat(sum);
		
		if(!isNaN(sk)&&($("#discount_rub_or_percent_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").val()==0)&&(parseFloat(sk)>sum)){	
			res=res&&false;
			local_res=local_res&&false;	
			$("#discount_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").focus();
			alert("Введенная %{$discs[discssec].name}% в рублях превышает цену позиции!");
			
			$("#discount_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").addClass("wrong");
		}else{
			$("#discount_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").removeClass("wrong");
		}
	}
	
	
	%{/section}%
	
	return res;
}

//проверка корр-ти цены
function IsCorrectPrice%{$prefix}%(id){
	res=true;
	
	//проверим цену
	sum=$("#price"+id+"%{$prefix}%").val();	
	sum=sum.replace("\,","\.");
	if((sum.length==0)||isNaN(sum)||(parseFloat(sum)<=0)){
		$("#price"+id+"%{$prefix}%").addClass("wrong");
		alert("Некорректно заполнено поле Цена!");
		$("#price"+id+"%{$prefix}%").focus();
		res=res&&false;	
	}else{
		$("#price"+id+"%{$prefix}%").removeClass("wrong");
	}
	
	
	
	return res;	
}


//проверка на взаимокорректность скидок (скидка не м.б. больше максимальной)
function IsCorrectBounds%{$prefix}%(id){
	res=true;
	
	%{section name=discssec loop=$discs}%
	
	local_res=true;
	sum=$("#price"+id+"%{$prefix}%").val();	
	sum=sum.replace("\,","\.");
	
	sk=$("#discount_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").val();	
	sk=sk.replace("\,","\.");
	
	max_sk=$("#dl_value_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").val();	
	max_sk=max_sk.replace("\,","\.");
	
	
	sk_in_rub=0;
	max_sk_in_rub=0;
	
	if($("#discount_rub_or_percent_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").val()==1){
		sk_in_rub=roundPlus(parseFloat(sum)*parseFloat(sk)/100,2);	
	}else{
		sk_in_rub=roundPlus(sk,2);
	}
	
	
	max_sk_descr='';
	if(max_sk!=""){
		if($("#dl_rub_or_percent_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").val()==1){
			max_sk_in_rub=roundPlus(parseFloat(sum)*parseFloat(max_sk)/100,2);	
			max_sk_descr=max_sk+'% ';
		}else{
			max_sk_in_rub=roundPlus(max_sk,2);
			max_sk_descr=max_sk+' руб. ';
		}
	}else max_sk_in_rub=sum;
	
	/*
	if(sk_in_rub>max_sk_in_rub){*/
	
	if(parseFloat(sk)>parseFloat(max_sk)){
		res=res&&false;
		alert("Введенная скидка превышает максимальную скидку "+max_sk_descr+"!");
		$("#discount_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").addClass("wrong");
		$("#dl_value_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").addClass("wrong");	
	}else{
		$("#discount_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").removeClass("wrong");
		$("#dl_value_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").removeClass("wrong");	
	}
	
	
	%{/section}%
	
	return res;	
}


//проверка корр-ти цены
//проверка корр-ти скидки (любой)






%{section name=rowsec loop=$items}%
	$("#quantity%{$items[rowsec].pl_id}%%{$prefix}%").bind("change", function(){
		$("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", true);
	});
	
	$("#price%{$items[rowsec].pl_id}%%{$prefix}%").bind("change", function(){
		
		res=true;
		res=res&&IsCorrectPrice%{$prefix}%("%{$items[rowsec].pl_id}%");
		if(res) res=res&&IsCorrectBounds%{$prefix}%("%{$items[rowsec].pl_id}%");
		if(res) res=res&&RecalcPrice%{$prefix}%("%{$items[rowsec].pl_id}%");
		
		 if(res) $("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", true);
		 else $("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", false);
		
		$("#price_was_changed%{$items[rowsec].pl_id}%%{$prefix}%").val('1');

		
	});
	
	
	
	$("#currency_id_%{$items[rowsec].pl_id}%%{$prefix}%").bind("change", function(){
		if($("#price_was_changed%{$items[rowsec].pl_id}%%{$prefix}%").val()==1){
			//сохраняем цену
			res=true;
			res=res&&IsCorrectPrice%{$prefix}%("%{$items[rowsec].pl_id}%");
			if(res){
				 
				$.ajax({
					async: true,
					url: "/js/pricelist.php",
					type: "POST",
					data:{
						"action":"update_price",
						"id":"%{$items[rowsec].pl_id}%", 
						"currency_id": $("#old_currency_id_%{$items[rowsec].pl_id}%%{$prefix}%").val(),
						"price": $("#price%{$items[rowsec].pl_id}%%{$prefix}%").val()
						
											},
					beforeSend: function(){
						  
					},
					success: function(data){
					  
					  //alert(data);
					},
					error: function(xhr, status){
						//alert("Ошибка выбора подгрупп.");	
					}	
				});
				
			}else{
				$("#currency_id_%{$items[rowsec].pl_id}%%{$prefix}%").val($("#old_currency_id_%{$items[rowsec].pl_id}%%{$prefix}%").val());	
				return false;
			}
		}
		
		//получить новую цену и пересчитать price_f
		$.ajax({
		  async: true,
		  url: "/js/pricelist.php",
		  type: "POST",
		  data:{
			  "action":"load_price",
			  "id":"%{$items[rowsec].pl_id}%", 
			  "currency_id": $("#currency_id_%{$items[rowsec].pl_id}%%{$prefix}%").val(),
							  },
		  beforeSend: function(){
			  $("#old_currency_id_%{$items[rowsec].pl_id}%%{$prefix}%").val($("#currency_id_%{$items[rowsec].pl_id}%%{$prefix}%").val()); 
			  $("#price%{$items[rowsec].pl_id}%%{$prefix}%").prop("disabled", true); 
		  },
		  success: function(data){
			$("#price%{$items[rowsec].pl_id}%%{$prefix}%").val(data);
			$("#price%{$items[rowsec].pl_id}%%{$prefix}%").prop("disabled", false);
			RecalcPrice%{$prefix}%("%{$items[rowsec].pl_id}%");
			//alert(data);
		  },
		  error: function(xhr, status){
			  //alert("Ошибка выбора подгрупп.");	
		  }	
	  });
		//
	});
	
	
	
	 %{foreach from=$items[rowsec].discs1 item=discs1}%
	 
	 //обработчик изменения макс скидки (любой)
	 $("#dl_value_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%").bind("change", function(){
		 res=true;
		  res=res&&IsCorrectMaxSk%{$prefix}%("%{$items[rowsec].pl_id}%");
		  if(res) res=res&&IsCorrectBounds%{$prefix}%("%{$items[rowsec].pl_id}%");
		  if(res) res=res&&RecalcPrice%{$prefix}%("%{$items[rowsec].pl_id}%");
		  
		   if(res) $("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", true);
		 else $("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", false);
	 });
	 $("#dl_rub_or_percent_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%").bind("change", function(){
		 res=true;
		 res=res&&IsCorrectMaxSk%{$prefix}%("%{$items[rowsec].pl_id}%");
		 if(res) res=res&&IsCorrectBounds%{$prefix}%("%{$items[rowsec].pl_id}%");
		 if(res) res=res&&RecalcPrice%{$prefix}%("%{$items[rowsec].pl_id}%");
		 
		  if(res) $("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", true);
		 else $("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", false);
	 });
	 
	 //обработчик изменения скидки (любой)
	 $("#discount_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%").bind("change", function(){
		 
		  
		  //сброс прочих скидок
		  if(parseFloat($(this).val())!==0){
				%{foreach from=$items[rowsec].discs1 item=discs2}%
				 %{if $discs2!=$discs1}%
				 $("#discount_%{$discs2.id}%_%{$items[rowsec].pl_id}%%{$prefix}%").val('0');
				 %{/if}%
				 %{/foreach}% 
		  }
		  
		  res=true;
		  res=res&&IsCorrectSk%{$prefix}%("%{$items[rowsec].pl_id}%");
		  if(res) res=res&&IsCorrectBounds%{$prefix}%("%{$items[rowsec].pl_id}%");
		  if(res) res=res&&RecalcPrice%{$prefix}%("%{$items[rowsec].pl_id}%");
		  
		   if(res) $("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", true);
		 else $("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", false);
	 });
	 $("#discount_rub_or_percent_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%").bind("change", function(){
		 res=true;
		 res=res&&IsCorrectSk%{$prefix}%("%{$items[rowsec].pl_id}%");
		 if(res) res=res&&IsCorrectBounds%{$prefix}%("%{$items[rowsec].pl_id}%");
		 if(res) res=res&&RecalcPrice%{$prefix}%("%{$items[rowsec].pl_id}%");
		 
		 if(res) $("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", true);
		 else $("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", false);
	 });
	 
	 %{/foreach}%
	
	
	
	
	
	
	
	
	$("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").bind("change", function(){
		if($(this).prop("checked")){
			 res=true;
		 res=res&&IsCorrectMaxSk%{$prefix}%("%{$items[rowsec].pl_id}%");
		  if(res) res=res&&IsCorrectSk%{$prefix}%("%{$items[rowsec].pl_id}%");
		 if(res) res=res&&IsCorrectBounds%{$prefix}%("%{$items[rowsec].pl_id}%");
		 if(res) res=res&&RecalcPrice%{$prefix}%("%{$items[rowsec].pl_id}%");
			
			
			if(!res) $(this).prop("checked", false);
		}
	});
	
	
	
	
	/***********************************************************************************/
	/*блок опций*/
	%{foreach from=$items[rowsec].options item=option}%
	$("#quantity%{$option.pl_id}%%{$prefix}%").bind("change", function(){
		$("#do_update_%{$option.pl_id}%%{$prefix}%").prop("checked", true);
	});
	
	$("#price%{$option.pl_id}%%{$prefix}%").bind("change", function(){
		
		res=true;
		res=res&&IsCorrectPrice%{$prefix}%("%{$option.pl_id}%");
		if(res) res=res&&IsCorrectBounds%{$prefix}%("%{$option.pl_id}%");
		if(res) res=res&&RecalcPrice%{$prefix}%("%{$option.pl_id}%");
		
		 if(res) $("#do_update_%{$option.pl_id}%%{$prefix}%").prop("checked", true);
		 else $("#do_update_%{$option.pl_id}%%{$prefix}%").prop("checked", false);
		
		$("#price_was_changed%{$option.pl_id}%%{$prefix}%").val('1');

		
	});
	
	
	
	$("#currency_id_%{$option.pl_id}%%{$prefix}%").bind("change", function(){
		if($("#price_was_changed%{$option.pl_id}%%{$prefix}%").val()==1){
			//сохраняем цену
			res=true;
			res=res&&IsCorrectPrice%{$prefix}%("%{$option.pl_id}%");
			if(res){
				 
				$.ajax({
					async: true,
					url: "/js/pricelist.php",
					type: "POST",
					data:{
						"action":"update_price",
						"id":"%{$option.pl_id}%", 
						"currency_id": $("#old_currency_id_%{$option.pl_id}%%{$prefix}%").val(),
						"price": $("#price%{$option.pl_id}%%{$prefix}%").val()
						
											},
					beforeSend: function(){
						  
					},
					success: function(data){
					  
					  //alert(data);
					},
					error: function(xhr, status){
						//alert("Ошибка выбора подгрупп.");	
					}	
				});
				
			}else{
				$("#currency_id_%{$option.pl_id}%%{$prefix}%").val($("#old_currency_id_%{$option.pl_id}%%{$prefix}%").val());	
				return false;
			}
		}
		
		//получить новую цену и пересчитать price_f
		$.ajax({
		  async: true,
		  url: "/js/pricelist.php",
		  type: "POST",
		  data:{
			  "action":"load_price",
			  "id":"%{$option.pl_id}%", 
			  "currency_id": $("#currency_id_%{$option.pl_id}%%{$prefix}%").val(),
							  },
		  beforeSend: function(){
			  $("#old_currency_id_%{$option.pl_id}%%{$prefix}%").val($("#currency_id_%{$option.pl_id}%%{$prefix}%").val()); 
			  $("#price%{$option.pl_id}%%{$prefix}%").prop("disabled", true); 
		  },
		  success: function(data){
			$("#price%{$option.pl_id}%%{$prefix}%").val(data);
			$("#price%{$option.pl_id}%%{$prefix}%").prop("disabled", false);
			RecalcPrice%{$prefix}%("%{$option.pl_id}%");
			//alert(data);
		  },
		  error: function(xhr, status){
			  //alert("Ошибка выбора подгрупп.");	
		  }	
	  });
		//
	});
	
	
	
	 %{foreach from=$option.discs1 item=discs1}%
	 
	 //обработчик изменения макс скидки (любой)
	 $("#dl_value_%{$discs1.id}%_%{$option.pl_id}%%{$prefix}%").bind("change", function(){
		 res=true;
		  res=res&&IsCorrectMaxSk%{$prefix}%("%{$option.pl_id}%");
		  if(res) res=res&&IsCorrectBounds%{$prefix}%("%{$option.pl_id}%");
		  if(res) res=res&&RecalcPrice%{$prefix}%("%{$option.pl_id}%");
		  
		   if(res) $("#do_update_%{$option.pl_id}%%{$prefix}%").prop("checked", true);
		 else $("#do_update_%{$option.pl_id}%%{$prefix}%").prop("checked", false);
	 });
	 $("#dl_rub_or_percent_%{$discs1.id}%_%{$option.pl_id}%%{$prefix}%").bind("change", function(){
		 res=true;
		 res=res&&IsCorrectMaxSk%{$prefix}%("%{$option.pl_id}%");
		 if(res) res=res&&IsCorrectBounds%{$prefix}%("%{$option.pl_id}%");
		 if(res) res=res&&RecalcPrice%{$prefix}%("%{$option.pl_id}%");
		 
		  if(res) $("#do_update_%{$option.pl_id}%%{$prefix}%").prop("checked", true);
		 else $("#do_update_%{$option.pl_id}%%{$prefix}%").prop("checked", false);
	 });
	 
	 //обработчик изменения скидки (любой)
	 $("#discount_%{$discs1.id}%_%{$option.pl_id}%%{$prefix}%").bind("change", function(){
		 
		  
		  //сброс прочих скидок
		  if(parseFloat($(this).val())!==0){
				%{foreach from=$option.discs1 item=discs2}%
				 %{if $discs2!=$discs1}%
				 $("#discount_%{$discs2.id}%_%{$option.pl_id}%%{$prefix}%").val('0');
				 %{/if}%
				 %{/foreach}% 
		  }
		  
		  res=true;
		  res=res&&IsCorrectSk%{$prefix}%("%{$option.pl_id}%");
		  if(res) res=res&&IsCorrectBounds%{$prefix}%("%{$option.pl_id}%");
		  if(res) res=res&&RecalcPrice%{$prefix}%("%{$option.pl_id}%");
		  
		   if(res) $("#do_update_%{$option.pl_id}%%{$prefix}%").prop("checked", true);
		 else $("#do_update_%{$option.pl_id}%%{$prefix}%").prop("checked", false);
	 });
	 $("#discount_rub_or_percent_%{$discs1.id}%_%{$option.pl_id}%%{$prefix}%").bind("change", function(){
		 res=true;
		 res=res&&IsCorrectSk%{$prefix}%("%{$option.pl_id}%");
		 if(res) res=res&&IsCorrectBounds%{$prefix}%("%{$option.pl_id}%");
		 if(res) res=res&&RecalcPrice%{$prefix}%("%{$option.pl_id}%");
		 
		 if(res) $("#do_update_%{$option.pl_id}%%{$prefix}%").prop("checked", true);
		 else $("#do_update_%{$option.pl_id}%%{$prefix}%").prop("checked", false);
	 });
	 
	 %{/foreach}%
	
	
	
	
	
	
	
	
	$("#do_update_%{$option.pl_id}%%{$prefix}%").bind("change", function(){
		if($(this).prop("checked")){
			 res=true;
		 res=res&&IsCorrectMaxSk%{$prefix}%("%{$option.pl_id}%");
		  if(res) res=res&&IsCorrectSk%{$prefix}%("%{$option.pl_id}%");
		 if(res) res=res&&IsCorrectBounds%{$prefix}%("%{$option.pl_id}%");
		 if(res) res=res&&RecalcPrice%{$prefix}%("%{$option.pl_id}%");
			
			
			if(!res) $(this).prop("checked", false);
		}
	});
	%{/foreach}%
%{/section}%
%{/if}%
</script>
</form>

%{if $smarty.section.rowsec.total==0}%
<em>По выбранным Вами условиям позиций не найдено.</em><br />
%{/if}%

%{$pages}%