
 
%{if $can_add}%
<div style="float:left; margin-right:10px;">

<input type="button" value="Добавить позицию..." id="pl_add_button" />
</div>
<script type="text/javascript">
$(function(){
	$("#pl_add_button").bind("click", function(){
		
		 
			alert("Внимание! Новая позиция добавляется только в прайс-лист поставщика!\nВ остальные прайс-листы позиция добавляется при этом автоматически.");
			 
		return false;
	});
});
</script>
%{/if}%


<div style="float:left; margin-right:10px;">
<input type="checkbox" name="lang_rus%{$prefix}%" id="lang_rus%{$prefix}%" value="1" %{if $lang_rus==1}% checked="checked"%{/if}% style="color:red;" /><label for="lang_rus%{$prefix}%" style="color:red;">русский язык</label>

&nbsp;&nbsp;&nbsp;
<input type="checkbox" name="lang_en%{$prefix}%" id="lang_en%{$prefix}%" value="1" %{if $lang_en==1}% checked="checked"%{/if}% style="color:red;" /><label for="lang_en%{$prefix}%"  style="color:red;">английский язык</label>


 
</div>

<script type="text/javascript">
$(function(){
	
	function FindDiv(){
		if(($("#lang_en%{$prefix}%").prop("checked")==true)&&($("#lang_rus%{$prefix}%").prop("checked")==true)){
			$("span[id^=copy_group_div]").css("display", "inline");	
			$("span[id^=group_div]").css("display", "inline");	
			$("span[id^=option_div]").css("display", "inline");	
		}else{
			$("span[id^=copy_group_div]").css("display", "none");	
			$("span[id^=group_div]").css("display", "none");	
			$("span[id^=option_div]").css("display", "none");	
		}
	}
	
	$("#lang_rus%{$prefix}%").bind("change", function(){
		
		
		if(($("#lang_en%{$prefix}%").prop("checked")==false)&&($("#lang_rus%{$prefix}%").prop("checked")==false)){
			$("#lang_rus%{$prefix}%").prop("checked", true);
			//$("#lang_rus%{$prefix}%").trigger("change");
		}
		
		if($("#lang_rus%{$prefix}%").prop("checked")){
			$("span[id^=copy_group_rus]").css("display", "inline");	
			  
			
			$("span[id^=group_rus]").css("display", "inline");	
			  
			$("span[id^=option_rus]").css("display", "inline");	
			 
		}else{
			$("span[id^=copy_group_rus]").css("display", "none");	
			  
			$("span[id^=group_rus]").css("display", "none");	
			  
			$("span[id^=option_rus]").css("display", "none");	
			 
		}
		FindDiv();
	});
	$("#lang_en%{$prefix}%").bind("change", function(){
		
		 
		if(($("#lang_en%{$prefix}%").prop("checked")==false)&&($("#lang_rus%{$prefix}%").prop("checked")==false)){
			$("#lang_rus%{$prefix}%").prop("checked", true);
			$("#lang_rus%{$prefix}%").trigger("change");
		}
		
		if($("#lang_en%{$prefix}%").prop("checked")){
			$("span[id^=copy_group_en]").css("display", "inline");	
			  
			
			$("span[id^=group_en]").css("display", "inline");	
			  
			$("span[id^=option_en]").css("display", "inline");	
			 
		}else{
			$("span[id^=copy_group_en]").css("display", "none");	
			  
			$("span[id^=group_en]").css("display", "none");	
			  
			$("span[id^=option_en]").css("display", "none");	
			 
		}
		FindDiv();
	});
	
});
</script>
 
%{$pages}%
 
<br clear="all" />




<table width="100%" border="0" cellpadding="2" cellspacing="0" class="reptable">
<thead>
<tr align="center" valign="top" class="equip">
	<th scope="col" width="40">
   №
   
    <div class="sort_dir">
    <a href="%{$link}%&sortmode%{$prefix}%=5"><img src="/img/up.gif" border="0" alt="" width="11" height="16" /></a>
    <a href="%{$link}%&sortmode%{$prefix}%=4"><img src="/img/down.gif" border="0" alt="" width="11" height="16" /></a>
    </div>
    </th>
    
    
    
    <th scope="col" width="40">
    Код позиции
    <div class="sort_dir">
    <a href="%{$link}%&sortmode%{$prefix}%=1"><img src="/img/up.gif" border="0" alt="" width="11" height="16" /></a>
    <a href="%{$link}%&sortmode%{$prefix}%=0"><img src="/img/down.gif" border="0" alt="" width="11" height="16" /></a>
    </div>
    </th>
    
  
    <th scope="col" width="*" style="min-width:150px;">
    Наименование
    <div class="sort_dir">
    <a href="%{$link}%&sortmode%{$prefix}%=3"><img src="/img/up.gif" border="0" alt="" width="11" height="16" /></a>
    <a href="%{$link}%&sortmode%{$prefix}%=2"><img src="/img/down.gif" border="0" alt="" width="11" height="16" /></a>
    </div>
    </th>
    
   
    
     <th scope="col" width="80">
   Производитель
   
    </th>
    
   <th scope="col" width="80">
   Раздел/ категория
   
    </th>
    
      <th width="30" scope="col">
    ед. изм.
   
    </th>
     <th width="50" scope="col">
    Кол-во
    </th>
    
     <th width="50" scope="col" style="color:blue;">
    Вид-ть цены в КП
    </th>
   
   
    <th width="50" scope="col">
    Доп. наценка,  руб. 
   
    </th>
   
   	 <th width="50" scope="col">
    Цена,  руб.
   
    </th>
    
    
    
    
    %{section name=discssec loop=$discs}%
     <th width="40" scope="col" >
    %{$discs[discssec].name}%
   
    </th>
    %{/section}%
    
    
  
    
    <th width="50" scope="col">
    Итоговая цена,  руб. 
   
    </th>
    
    <th scope="col" width="40">
    Файлы
    </th>
   
  
   
    <th width="24" scope="col">
    
     
      %{if $can_edit}%
      <a href="#" id="saveSelected%{$prefix}%"><img src="/img/icons/save.png" width="24" height="24" title="Сохранить изменения в выбранных позициях" alt="Сохранить изменения в выбранных позициях" border="0" /></a>
      <script type="text/javascript">
	  $(function(){
		$("#saveSelected%{$prefix}%").bind("click", function(){
			
			if($("input[id^=do_update_]:checked").length==0){
				alert("Выделите позиции для редактирования!");	
				return false;
			}
			
			if(window.confirm("Вы действительно хотите внести изменения в выбранные позиции прайс-листа?")){
			
				//changing ajax
				var checked_ids=new Array();
				var strs=new Array();
				var price=new Array();
				var currency_id=new Array();
				
				
				var discount_id=new Array();
				var discount_value=new Array();
				var discount_rub_or_percent=new Array();
				
				var dl_value=new Array();
				var dl_rub_or_percent=new Array();
				
			
				var res=true;
				$("input[id^=do_update_]:checked").each(function(index, el) {
                 	res=res&&IsCorrectMaxSk%{$prefix}%($(el).val());
					//if(res) res=res&&IsCorrectSk%{$prefix}%($(el).val());
				   //	if(res) res=res&&IsCorrectBounds%{$prefix}%($(el).val());
				   	if(res) res=res&&RecalcPrice%{$prefix}%($(el).val());
				 
				});
				if(!res){
					return false;	
					
				}
				
				
				$("input[id^=do_update_]:checked").each(function(index, el) {
                    
					
					checked_ids.push($(el).val());
					id=$(el).val();
					
					price.push($("#price"+id+"%{$prefix}%").val());
					
					currency_id.push($("#currency_id_"+id+"%{$prefix}%").val());
					
					
					//перебрать данные для всех скидок. какая ненулевая и есть ли такая - определить серверный скрипт
					discount_id_1=new Array();
					discount_value_1=new Array();
					discount_rub_or_percent_1=new Array();
					
					dl_value_1=new Array();
					dl_rub_or_percent_1=new Array();
					
					if($("#parent_id"+id+"%{$prefix}%").val()==0){
					  %{foreach from=$discs item=discs1}%
					  discount_id_1.push("%{$discs1.id}%");
					 // discount_value_1.push($("#discount_%{$discs1.id}%_"+id+"%{$prefix}%").val().replace("\,","\.")); 
					 // discount_rub_or_percent_1.push($("#discount_rub_or_percent_%{$discs1.id}%_"+id+"%{$prefix}%").val().replace("\,","\.")); 
					  
					  dl_value_1.push($("#dl_value_%{$discs1.id}%_"+id+"%{$prefix}%").val().replace("\,","\.")); 
					  dl_rub_or_percent_1.push($("#dl_rub_or_percent_%{$discs1.id}%_"+id+"%{$prefix}%").val().replace("\,","\.")); 
					   
					  %{/foreach}%
					}
					discount_id.push(discount_id_1);
					discount_value.push(discount_value_1);
					discount_rub_or_percent.push(discount_rub_or_percent_1);
					
					dl_value.push(dl_value_1);
					dl_rub_or_percent.push(dl_rub_or_percent_1);
					
						
                });
				
				//alert(currency_id); return false;
				
				
				
				$.ajax({
					async: true,
					url: "/js/pricelist.php",
					type: "POST",
					data:{
						"action":"edit_items",
						"checked_ids[]":checked_ids,
						"price[]":price,
						"currency_id[]":currency_id,
						"discount_id[]":discount_id,
						"discount_value[]":discount_value,
						"discount_rub_or_percent[]":discount_rub_or_percent,
						"dl_value[]":dl_value,
						"dl_rub_or_percent[]":dl_rub_or_percent,
						"price_kind_id":$('#price_kind_id%{$prefix}%').val()
											},
					beforeSend: function(){
						  
					},
					success: function(data){
					  //alert(data);
					  location.reload();
					  //$("#group_id3%{$prefix}%").html('<option value=""></option>'+data);
					  
					},
					error: function(xhr, status){
						//alert("Ошибка выбора подгрупп.");	
					}	 
				});
			}
			return false;
		});
	  });
	  </script>
     %{/if}%
     </th>
    
   
    
    
     <th scope="col" width="24">
     
    
     
     
     </th>
    <th scope="col" width="24">&nbsp;</th>
   
   
</tr>
<tr align="center" valign="top" class="equip">
	<td width="40">
  <input type="text" size="4" maxlength="255" value="%{$pl_id}%" name="pl_id%{$prefix}%" id="id%{$prefix}%" style="width:40px;" />
     
    </td>
    
    <td width="40">
	 <input type="text" size="4" maxlength="255" value="%{$code}%" name="code%{$prefix}%" id="code%{$prefix}%" style="width:40px;" />
    
    </td>
    
   
	<td width="*" style="min-width:150px;" >
   <input type="text" size="10" maxlength="255" value="%{$name}%" name="name%{$prefix}%" id="name%{$prefix}%"  />
    
    </td>
    
    
    
     <td width="80">
     
       <input type="text" size="5" maxlength="255" value="%{$producer_name}%" name="producer_name%{$prefix}%" id="producer_name%{$prefix}%" />
    </td>
    
    
    <td width="80">
    </td>
    
     <td  width="30">
    <select name="dimension_id%{$prefix}%" id="dimension_id%{$prefix}%" style="width:30px;">
    %{section name=dimsec loop=$dim}%
    	<option value="%{$dim[dimsec].id}%" %{if $dim[dimsec].is_current}%selected="selected"%{/if}%>%{$dim[dimsec].name|escape:"html"}%</option>
    %{/section}%
    </select>
    
    
    </td>
     <td width="50">
     %{if $can_create_kp}%
     
      
       <a href="#" id="makeKP%{$prefix}%"><img src="/img/icons/new-kp.png" width="24" height="24" title="создать коммерческое предложение" alt="создать коммерческое предложение" border="0" /></a> 
       <script type="text/javascript">
	   $(function(){
	   		$("#makeKP%{$prefix}%").bind("click", function(){
				 
				var cter=0;
				$("input[id^=parent_id]").each(function(index, v) {
                    opt_id=$(v).attr("id").replace(/^parent_id/,'').replace(/%{$prefix}%$/,'');
					
					qua=$("#quantity"+opt_id+"%{$prefix}%").val().replace(/,/,'.');
					if(($(v).val()==0)&&(qua>0)){
						cter++;	
					}
                });
				
				if(cter==0){
					alert('Выберите оборудование для создания коммерческого предложения!');
					return false;	
				}
				
				 
				
				
				var res=true;
				$("input[id^=quantity]").each(function(index, v) {
					opt_id=$(v).attr("id").replace(/^quantity/,'').replace(/%{$prefix}%$/,'');
					//пропускать неактивные опции...
					//q_a%{$option.pl_id}%%{$prefix}%
					try{
					if(($(v).val()>0)&&($("#q_a"+opt_id+"%{$prefix}%").prop("checked"))){	
					  if(res) res=res&&IsCorrectPrice%{$prefix}%(opt_id);
					  if(res) res=res&&IsCorrectQuantity%{$prefix}%(opt_id);
					  if(res) res=res&&IsCorrectBounds%{$prefix}%(opt_id);
					  
					  
					}
					}catch(e){}
				});
				
				 if(res)  res=res&&IsCorrectPriceF%{$prefix}%();
				
				if(!res){
					alert('Введите корректные данные для создания коммерческого предложения!');
					return false;	
				}
				//строим урл для создания кп
				
				var url=''; var is_correct=true;
				$("input[id^=quantity]").each(function(index, v) {
					
					opt_id=$(v).attr("id").replace(/^quantity/,'').replace(/%{$prefix}%$/,'');
					//если это не опция - проверить кол-во>0
					//если это опция - проверить отмеченность галочкой и кол-во>0
					parent_id=$("#parent_id"+opt_id+"%{$prefix}%").val();
					do_it=false;
					
					qua=$(v).val().replace(/,/,'.');
					
					if(parent_id==0){
						if(qua>0) do_it=true;
					}else{
						if((qua>0)&&($("#q_a"+opt_id+"%{$prefix}%").prop("checked"))&&($("#quantity"+parent_id+"%{$prefix}%").val()>0)) do_it=true;
					}
					
					if(do_it){
					  //alert(opt_id);
					  quantity=$("#quantity"+opt_id+"%{$prefix}%").val();
					  //alert(quantity);
					  quantity=quantity.replace(/,/,'.');
					  
					  //передать валюту
					  currency_id=$("#currency_id_"+opt_id+"%{$prefix}%").val();
					  
					  //передать базовую цену
					  price=$("#price"+opt_id+"%{$prefix}%").val().replace("\,","\.");
					  
					  //передать доп. наценку...
					  extra_charges=$("#extra_charges"+opt_id+"%{$prefix}%").val().replace("\,","\.");
					  
					  //содержится ли цена в КП???
					  print_form_has_komplekt=1;
					  if($("#print_form_has_komplekt"+opt_id+"%{$prefix}%").prop("checked")) print_form_has_komplekt=1;
					  else print_form_has_komplekt=0;
					  
					  
					  //передать скидку выбранную 
					  discount_id=1; discount_value=0; discount_rub_or_percent=1;
					
						//для обор-ия - берем его скидку
						%{foreach from=$discs item=discs1}%
						if($("#discount_%{$discs1.id}%_"+"%{$prefix}%").val().replace("\,","\.")>0){
							discount_id=%{$discs1.id}%;
							discount_value=$("#discount_%{$discs1.id}%_"+"%{$prefix}%").val().replace("\,","\.");
							
						}
						 
						%{/foreach}%
					  
						 
						 
					 
					  
					  						  
					  url=url+'&pl_position_id[]='+opt_id+';'+parent_id+';'+quantity+';'+currency_id+';'+price+';'+discount_id+';'+discount_value+';'+discount_rub_or_percent+';'+$("#price_kind_id%{$prefix}%").val()+';'+print_form_has_komplekt+';'+extra_charges;
					}//else alert('skip');
				});
			
				//alert(url);
				
				if($("#lang_rus%{$prefix}%").prop("checked")) url=url+'&lang_rus=1';
				else url=url+'&lang_rus=0';
				
				if($("#lang_en%{$prefix}%").prop("checked")) url=url+'&lang_en=1';
				else url=url+'&lang_en=0';
				
				
			 	
				
				if(($("#from_kp%{$prefix}%").val()!="")&&($("#from_kp%{$prefix}%").val()!=0)){
					url="ed_kp.php?action=1&id="+$("#from_kp%{$prefix}%").val()+"&from_begin=1&price_kind_id="+$("#price_kind_id%{$prefix}%").val()+url;
				}else{
					url="ed_kp.php?action=0&from_begin=1&price_kind_id="+$("#price_kind_id%{$prefix}%").val()+url;
				}
				location.href=url;
				//location.href="ed_kp.php?action=0&from_begin=1&price_kind_id="+$("#price_kind_id%{$prefix}%").val()+url;
				
				
				
				 
				return false;
			});
	   });
       </script>
   
     
     %{else}%
       <a href="#" id="makeKP%{$prefix}%" onclick="alert('У Вас недостаточно прав для создания коммерческого предложения!'); return false;"><img src="/img/icons/new-kp-gr.png" width="24" height="24" title="создать коммерческое предложение" alt="создать коммерческое предложение" border="0" /></a> 
     %{/if}%
     </td>
     
     
     <td width="50">
   
   
    </td>
    
     <td width="50">
   
   
    </td>
    
    <td width="50">
   
   
    </td>
    
    
 
    
  %{foreach from=$discs item=discs1}%
	<td width="40" style="white-space:nowrap;" align="left">
    
    %{if $items[rowsec].discount_id==$discs1.id}%
      <input type="text" size="4" maxlength="255" value="0" id="discount_%{$discs1.id}%_%{$prefix}%"   %{if ($discs1.id==2 and !$can_ruk_discount) or ($discs1.id==1 and  $can_ruk_discount)}% disabled="disabled"%{/if}%      />
     
   
  
    %{else}%
      <input type="text" size="4" maxlength="255" value="0.00" id="discount_%{$discs1.id}%_%{$prefix}%"  %{if ($discs1.id==2 and !$can_ruk_discount) or ($discs1.id==1 and  $can_ruk_discount)}% disabled="disabled"%{/if}%      />
    
      
    %{/if}%
    %
     
    
    %{if $discs1.id==2}%
    <script type="text/javascript">
	$(function(){
		
		 
		
		
		//блок подтверждения скидки рук-ля с выводом рент-ти
		var old_disc=$("#discount_2_%{$prefix}%").val();
		
		 
		
		$("#discount_2_%{$prefix}%").bind("change", function(){
			try{
				old_disc=parseFloat($("#discount_2_%{$prefix}%").val());
			}catch(e){}
		});
		  
	  
	});
	</script>
    %{/if}%
    
    <input type="hidden" id="discount_rub_or_percent_%{$discs1.id}%_%{$prefix}%"  value="1" />
    
   
    
     <input type="hidden" value="1"  id="dl_rub_or_percent_%{$discs1.id}%_%{$prefix}%" />
    
    
    <input type="hidden" value="%{$discs1.id}%" id="dl_discount_id_%{$discs1.id}%_%{$prefix}%" />
     
    </td>
    %{/foreach}%   
    
    
    
    <td width="40">
    <input id="price_f%{$prefix}%" type="text" value="0" size="7" maxlength="20" />
    
    </td>
    
    
     
    <td width="24">&nbsp;
    
   
    </td>
    
     <td width="24">
    <input type="checkbox" id="selectAll%{$prefix}%" %{if !$can_edit and !$can_create_kp}% disabled="disabled"%{/if}%  />
   <script type="text/javascript">
   $(function(){
	  $("#selectAll%{$prefix}%").bind("change", function(){
		 $("input[type=checkbox][id^=do_update_]").prop('checked', $(this).prop("checked"));
	  });
   });
   </script>
    </td>
   
   
    <td width="24">
  
    </td>
    
     <td width="24"></td>
  
</tr>
</thead>
<tbody>
%{section name=rowsec loop=$items}%
<tr align="center" valign="top" class="equip">
	
   
   <td width="40"><a name="#user_%{$option.pl_id}%%{$prefix}%"></a>%{$items[rowsec].pl_id}%
    <input type="hidden"  value="%{$items[rowsec].parent_id}%" id="parent_id%{$items[rowsec].pl_id}%%{$prefix}%"  />
    
    
    <input type="hidden"  value="%{$items[rowsec].is_install}%" id="is_install%{$items[rowsec].pl_id}%%{$prefix}%"   />
    <input type="hidden"  value="%{$items[rowsec].delivery_ddpm}%" id="delivery_ddpm%{$items[rowsec].pl_id}%%{$prefix}%"   />
   </td>
   
    <td width="40"> %{$items[rowsec].code}%</td>
   
   
    <td width="*"  style="min-width:150px;">
    
    %{$items[rowsec].name}%
    
    
    </td>
   
    <td width="80">%{$items[rowsec].producer_name}%</td>
   
    <td width="80">%{$items[rowsec].group_name}%</td>
    
    <td width="30">%{$items[rowsec].dim_name}%</td>
    
    
    <td width="50">
   <input type="text" size="7" maxlength="255" value="0" id="quantity%{$items[rowsec].pl_id}%%{$prefix}%"  />
   
   <!--
    <input type="checkbox" value="1" id="q_a%{$items[rowsec].pl_id}%%{$prefix}%" style="margin-right:0px;"
    %{if $id!=""}%
    checked="checked" disabled="disabled"
    %{/if}%
     
      />
    -->
   
    </td>
    
    <td width="50" style="white-space:nowrap;">
    <input type="checkbox" value="1" id="print_form_has_komplekt%{$items[rowsec].pl_id}%%{$prefix}%"  
     
      %{if $items[rowsec].print_form_has_komplekt==1 }% checked="checked" %{/if}%
     
     
      />
    </td>
    
    
    <td width="50" style="white-space:nowrap;">
    
       <input type="text" size="5" maxlength="255" value="%{$items[rowsec].extra_charges}%"  id="extra_charges%{$items[rowsec].pl_id}%%{$prefix}%"    />
      
    </td>
    
   
    <td width="50"  >
    <input type="text" size="7" maxlength="255" value="%{$items[rowsec].price}%"  id="price%{$items[rowsec].pl_id}%%{$prefix}%"   disabled="disabled" />
    
     <input type="hidden" size="7" maxlength="255" value="%{$items[rowsec].price}%"  id="price_base%{$items[rowsec].pl_id}%%{$prefix}%"   disabled="disabled" />
    
    <select id="currency_id_%{$items[rowsec].pl_id}%%{$prefix}%" style="width:45px; display:none;" %{if !$can_edit}% disabled="disabled"%{/if}%>
    %{foreach from=$currencies item=currency}%
     <option value="%{$currency.id}%" %{if $items[rowsec].currency_id==$currency.id or ($items[rowsec].currency_id==false and $currency.id==2)}% selected="selected"%{/if}% >%{$currency.signature}%</option>
    %{/foreach}%
    </select>
   
    <input type="hidden" value="0" id="price_was_changed%{$items[rowsec].pl_id}%%{$prefix}%" />
  <input type="hidden" value="%{$items[rowsec].currency_id|default:"2"}%" id="old_currency_id_%{$items[rowsec].pl_id}%%{$prefix}%" />
  
    </td>
    
    
    
    
    %{foreach from=$items[rowsec].discs1 item=discs1}%
	 
    <td width="40" style="white-space:nowrap;" align="left">
    
    
    %{if $can_max_val}%
      <!-- ecли есть ограничения, нужно их также выписать -->
     
      Макс. скидка:<br />
  
      <input type="text" size="4" maxlength="255" value="%{$discs1.dl_value}%"   id="dl_value_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%" %{if !$can_edit}% disabled="disabled"%{/if}% />
      %
    %{else}%
      
      <input type="hidden" value="%{$discs1.dl_value}%"   id="dl_value_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%" />
    
      
    %{/if}%
   
    
     <input type="hidden" value="1"  id="dl_rub_or_percent_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%" />
    
    
    <input type="hidden" value="%{$discs1.id}%" id="dl_discount_id_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%" />
     
    </td>
    %{/foreach}%
    
    
   
   
    <td width="50" style="white-space:nowrap;"  >
   
   
   <span id="price_f%{$items[rowsec].pl_id}%%{$prefix}%"  >%{$items[rowsec].price_f}%</span>
    <span id="signature%{$items[rowsec].pl_id}%%{$prefix}%" style="display:none;">%{$items[rowsec].signature}%</span>
   
   
   
    </td>
   
   
  
  
     <td width="40">
      <a href="pos_files.php?bill_id=%{$items[rowsec].pl_id}%" target="_blank"><img src="/img/files.png" width="47" height="25" alt="Файлы" border="0" /></a></td>
                        
 
     
        <td width="24">
     <input type="checkbox" id="do_update_%{$items[rowsec].pl_id}%%{$prefix}%" %{if !$can_edit  and !$can_create_kp}% disabled="disabled"%{/if}% value="%{$items[rowsec].pl_id}%"  onchange="try{ if(!$('#selectAll%{$prefix}%').prop('disabled')){   x=$('input[type=checkbox][id^=do_update]:enabled').length;  y=$('input[type=checkbox][id^=do_update]:enabled:checked').length;  $('#selectAll%{$prefix}%').prop('checked',(x==y));  };  }catch(e){};"  />
     </td>
             
                        
    <td width="24">
    %{if $can_edit}%
   
    <a href="ed_pl_position.php?action=1&id=%{$items[rowsec].id}%" target="_blank"><img src="/img/icons/edit.png" width="24" height="24" alt="карточка товара в номенклатуре..." title="карточка товара в номенклатуре..." border="0" /></a>
    
    %{/if}%
    </td>
    
    <td width="24">
    %{if $can_delete}%
    
    %{if $items[rowsec].can_delete}%
    <a href="#" onclick="if(window.confirm('Вы действительно хотите удалить позицию прайс-листа %{$items[rowsec].name|escape}%?')) location.href='pricelist.php?action=2&id=%{$items[rowsec].pl_id}%'; return false;">
    %{/if}%
    <img src="/img/icons/delete%{if $items[rowsec].can_delete==false}%_inactive%{/if}%.png" width="24" height="24" alt="удалить..." title="удалить..." border="0" />
    %{if $items[rowsec].can_delete}%
    </a>
    %{/if}%
    
   
    %{/if}%
    </td>
</tr>

</tbody>
   

%{/section}%

</table>


%{$pages}%

<script type="text/javascript">
function roundPlus(x, n) { //x - число, n - количество знаков
  if(isNaN(x) || isNaN(n)) return false;
  var m = Math.pow(10,n);
  return Math.round(x*m)/m;
}

%{if $can_create_kp or $can_edit}%


/*вводимая скидка:
а) не должна превышать максимальную
б) обнуляет все другие скидки
в) пересчитывает итоговую цену
*/


var overal_summ=0; //общая сумма КП До доставки - ищем ее до скидок в теле функции  ApplyDeliveryDDPM
var new_overal_summ=0; //общая сумма КП после доставки
var delivery_ddpm=0; //сумма доставки
var selected_items=new Object(); //объект со стоимостями отобранного оборудования ДО применения скидок
var selected_sk_items=new Object(); //объект со скидками в % на каждую позицию

var eq_id=0; //код оборудования для КП 

//наложение доставки DDPM
function ApplyDeliveryDDPM(){
	
	//alert(overal_summ); alert(	delivery_ddpm);	
	//alert(eq_id);
	
	//найдем общую сумму КП
	overal_summ=0;
	$.each(selected_items, function(k,v){
		overal_summ+=v;
	});
	
	//alert('Общая сумма КП до скидок:'+overal_summ);
	
	new_overal_summ=0; test_sum_of_delta=0;
	//var deltas=new Object();
	
	%{if $price_kind_id==1}%
	/*
	блок разбивки доставки. отключим его! доставка теперь вычисляется на станок
	$.each(selected_items, function(k,v){
		//alert(k+" = "+v);
		x=0;
		try{
			x=delivery_ddpm*v/overal_summ;
		}catch(e){}
		
		//alert('Позиция '+k+" сумма="+v+' добавим '+x+' получим '+(v+x));
		 
		selected_items[k]=v+x;
		//deltas[k]=x;
		
		new_overal_summ+=v+x;
		
		
		test_sum_of_delta+=x;
	});*/
	%{/if}%
	
	
	//alert('итого мы добавим к сумме: '+test_sum_of_delta);
	//alert('Новое итого по КП до скидок: '+new_overal_summ);
	//$("#price_f"+eq_id+"%{$prefix}%").html(roundPlus(new_overal_summ, 2));
	
	
	//может, нам запоминать массив скидок в % для каждой позиции, и затем его применять????
	//тогда как это будет работать для EXW??????????
	//отключить штатный механизм применения скидок, задействовать внутренний
	//только в случае Prince_kind_id==1 применять также дельты.
	new_overal_summ=0;
	$.each(selected_items, function(k,v){
		skidka=selected_sk_items[k];
		if(skidka!=undefined){
			selected_items[k]=selected_items[k]*(100-skidka)/100;
		}
		
		//alert('Скидка для позиции '+k+' равна '+skidka+'%, новая сумма по позиции='+selected_items[k]);
		$("#price_f"+k+"%{$prefix}%").html(roundPlus(selected_items[k],0));
		
		new_overal_summ+=selected_items[k];
	});
	
	
	//alert('Новое итого по КП c применением скидок: '+new_overal_summ);
	$("#price_f"+eq_id+"%{$prefix}%").html(roundPlus(new_overal_summ, 0));
	
}


//перенос выбранных и не выбранных опций 
function TransferOption%{$prefix}%(id){
	 
}



//перерасчет цены (без проверки корр-ти)
function RecalcPrice%{$prefix}%(id, recursive){
	//alert('работаю для позиции '+id);
	var recursive=recursive||2; //по умолчанию  вызывать себя снова
	
	res=true;
	var sum_export=0;
	
	sum=$("#price_base"+id+"%{$prefix}%").val();	
	sum=sum.replace("\,","\.");
	if((sum.length>0)&&!isNaN(sum)) sum=parseFloat(sum);
	else sum=0;
	
	
	
	//применение доп. наценки
	 
		extra_charges=$("#extra_charges"+id+"%{$prefix}%").val();
		extra_charges=extra_charges.replace("\,","\.");
		if((extra_charges.length>0)&&!isNaN(extra_charges)) extra_charges=parseFloat(extra_charges);
		else extra_charges=0;
		
		$("#price"+id+"%{$prefix}%").val( roundPlus(sum+extra_charges,0) );
		
		sum+=extra_charges;
		//alert('z');
	 
	
	
	
	
	skidka=0; skidka_own=0; sk_own=0;
	
	var quantity='0';
	quantity=$("#quantity"+id+"%{$prefix}%").val();
	
	
   	quantity=quantity.replace("\,","\.");
	if((quantity.length>0)&&!isNaN(quantity)) quantity=parseFloat(quantity);
	else quantity=0;
	
	sum=sum*quantity;
	//alert(quantity);
	
	mode='';
	
	sk='0';
	 
	  	id_key=id;
	 
	
	
	 
	
	
	
	
	//применение скидок.
	
	//найти любую скидку не нулевую
	%{section name=discssec loop=$discs}%
	sk=$("#discount_"+"%{$discs[discssec].id}%"+"_"+"%{$prefix}%").val();	
	sk=sk.replace("\,","\.");
	
	if((sk!="")&&!isNaN(sk)&&(parseFloat(sk)>0)){
	 
		 skidka=parseFloat(sk);
		 skidka_own=0;
		 mode="%{$discs[discssec].id}%";
	}
	%{/section}%
	
	
	 
	sum=(parseFloat(sum)-parseFloat(sum)*parseFloat(skidka)/100);				
	
	var currency_id=$("#currency_id_"+id+"%{$prefix}%").val();
	
 
	
	
	sum=roundPlus(sum,0);
	
	$("#price_f"+id+"%{$prefix}%").text(sum);
	
	$("#signature"+id+"%{$prefix}%").text($("#currency_id_"+id+"%{$prefix}% option:selected").html());
	
	 
	//вызвать расчет общей цены
	 var all_sum=0;
	 $("input[id^=quantity]").each(function(index, v) {
	 	opt_id=$(v).attr("id").replace(/^quantity/,'').replace(/%{$prefix}%$/,'');
		if(parseFloat($(v).val().replace(/\,/,'.'))>0){
			
			
			
			all_sum+=parseFloat($(v).val().replace(/\,/,'.'))*parseFloat($("#price"+opt_id+"%{$prefix}%").val().replace(/\,/,'.'));
		}
	 });
	 
	 //применим скидку
	 
	all_sum=parseFloat(all_sum)-parseFloat(all_sum)*parseFloat(skidka)/100;	
	
	$("#price_f%{$prefix}%").val(roundPlus(all_sum,0));
	
	return res;
}



//нахождение скидки по заданной сумме
function FindSkBySum%{$prefix}%(){
	res=true;
	
	var neat_sum=0; var sum_with_skidka=$("#price_f%{$prefix}%").val().replace(/\,/,'.');
	
	//найдем цену по оборудованию
	
	
	//прибавим опции 
	var opt_id=0;
	 $("input[id^=quantity]").each(function(index, v) {
					
		opt_id=$(v).attr("id").replace(/^quantity/,'').replace(/%{$prefix}%$/,'');
		if(parseFloat($(v).val().replace(/\,/,'.'))>0){
			
						//alert(opt_id);
						
						neat_sum=neat_sum+parseFloat($("#quantity"+opt_id+"%{$prefix}%").val().replace(/\,/,'.'))*parseFloat($("#price"+opt_id+"%{$prefix}%").val().replace(/\,/,'.'));
						
						
						
					}	
	});
	
	//alert(neat_sum);
	//получена стоимость КП без скидки
	
	//найдем скидку		
	
	delta=neat_sum-sum_with_skidka;
	
	
	
	skidka_percent=0;
	
	
	try{
		 
		skidka_percent=roundPlus(100*delta/(neat_sum),2);
	}catch(e){
		alert("Ошибка при расчете скидки!");	
	}
	
	
	/*
	$("#discount_1_%{$prefix}%").val(skidka_percent);
	
	$("#discount_1_%{$prefix}%").trigger("change");
	*/
	
	/*найти доступное поле...
	далее - проверять весь комплекс условий*/
	if($("#discount_1_%{$prefix}%").prop("disabled")) field=$("#discount_2_%{$prefix}%");
	else if($("#discount_2_%{$prefix}%").prop("disabled")) field=$("#discount_1_%{$prefix}%"); 
	
	
	//если нет прав "752" и скидка превышает макс. допустимую - то в поле "скидка рук-ля"
	//can_override_ruk_discount
	%{if !$can_override_ruk_discount}%
	 
	max_sk=$("#dl_value_1_"+opt_id+"%{$prefix}%").val();	
	max_sk=max_sk.replace("\,","\.");
	if(parseFloat(skidka_percent)>parseFloat(max_sk)){
		 
		field=$("#discount_2_%{$prefix}%");
		
		alert("Внимание! Введенная Вами скидка "+skidka_percent+"% превышает максимальную скидку "+max_sk+"%.\nУтвердить эту скидку имеют право следующие сотрудники: %{strip}%
		%{foreach name=us from=$users_can_override_ruk_discount item=user}%
		%{$user.name_s}% (%{$user.login}%)%{if !$smarty.foreach.us.last}%, %{/if}%
		
		%{/foreach}%
		%{/strip}%!");
	}
	
	%{/if}%	
	 
	
	$(field).val(skidka_percent).trigger("change");
	
	
	
	return res;	
}


//проверка корр-ти итоговой стоимости
function IsCorrectPriceF%{$prefix}%(){
	res=true;
	
	//проверим цену
	sum=$("#price_f%{$prefix}%").val();	
	sum=sum.replace("\,","\.");
	if((sum.length==0)||isNaN(sum)||(parseFloat(sum)<=0)){
		$("#price_f%{$prefix}%").addClass("wrong");
		alert("Некорректно заполнено поле Итоговая цена!");
		$("#price_f%{$prefix}%").focus();
		res=res&&false;	
	}else{
		$("#price_f%{$prefix}%").removeClass("wrong");
	}
	
	
	
	return res;	
}


//проверка корр-ти макс. скидки (любой)
function IsCorrectMaxSk%{$prefix}%(id){
	res=true;
	
	
	if($("#parent_id"+id+"%{$prefix}%").val()!=0){
		return res;	
	}
	
	%{section name=discssec loop=$discs}%
	
	
	local_res=true;
	sk=$("#dl_value_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").val();	
	sk=sk.replace("\,","\.");
	if((sk!="")&&(isNaN(sk)||(parseFloat(sk)<0))){
		res=res&&false;
		local_res=local_res&&false;	
		$("#dl_value_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").focus();
		alert("Некорректно заполнено максимальное значение поля %{$discs[discssec].name}%!");
		
		$("#dl_value_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").addClass("wrong");
		
	}else $("#dl_value_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").removeClass("wrong");
	
	
	//если выбраны ПРОЦЕНТЫ: то не более 99.99 процентов
	if(local_res){
	  if((sk!="")&&!isNaN(sk)&&($("#dl_rub_or_percent_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").val()==1)&&(parseFloat(sk)>99.99)){		
	  		res=res&&false;
			local_res=local_res&&false;	
			$("#dl_value_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").focus();
			alert("Некорректно заполнено максимальное значение поля %{$discs[discssec].name}%!");
			
			$("#dl_value_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").addClass("wrong");
			
	  }else $("#dl_value_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").removeClass("wrong");
	
	}
	
	
	
	%{/section}%
	
	return res;
}

 

//проверка корр-ти скидки (любой)
function IsCorrectSk%{$prefix}%(id){
	res=true;

	
	%{section name=discssec loop=$discs}%
	
	local_res=true;
	sk=$("#discount_"+"%{$discs[discssec].id}%"+"_"+"%{$prefix}%").val();	
	sk=sk.replace("\,","\.");
	if((sk=="")||isNaN(sk)||(parseFloat(sk)<0)){
		res=res&&false;
		local_res=local_res&&false;	
		$("#discount_"+"%{$discs[discssec].id}%"+"_"+"%{$prefix}%").focus();
		alert("Некорректно заполнено значение поля %{$discs[discssec].name}%!");
		
		$("#discount_"+"%{$discs[discssec].id}%"+"_"+"%{$prefix}%").addClass("wrong");
		
	}else $("#discount_"+"%{$discs[discssec].id}%"+"_"+"%{$prefix}%").removeClass("wrong");
	
	
	//если выбраны ПРОЦЕНТЫ: то не более 99.99 процентов
	if(local_res){
	  if(!isNaN(sk)&&($("#discount_rub_or_percent_"+"%{$discs[discssec].id}%"+"_"+"%{$prefix}%").val()==1)&&(parseFloat(sk)>99.99)){		
	  		res=res&&false;
			local_res=local_res&&false;	
			$("#discount_"+"%{$discs[discssec].id}%"+"_"+"%{$prefix}%").focus();
			alert("Некорректно заполнено максимальное значение поля %{$discs[discssec].name}%!");
			
			$("#discount_"+"%{$discs[discssec].id}%"+"_"+"%{$prefix}%").addClass("wrong");
			
	  }else $("#discount_"+"%{$discs[discssec].id}%"+"_"+"%{$prefix}%").removeClass("wrong");
	
	}
	
	 
	
	%{/section}%
	
	return res;
}

//проверка корр-ти цены
function IsCorrectPrice%{$prefix}%(id){
	res=true;
	
	//проверим цену
	sum=$("#price"+id+"%{$prefix}%").val();	
	sum=sum.replace("\,","\.");
	if((sum.length==0)||isNaN(sum)||(parseFloat(sum)<=0)){
		$("#price"+id+"%{$prefix}%").addClass("wrong");
		alert("Некорректно заполнено поле Цена!");
		$("#price"+id+"%{$prefix}%").focus();
		res=res&&false;	
	}else{
		$("#price"+id+"%{$prefix}%").removeClass("wrong");
	}
	
	
	
	return res;	
}



//проверка корр-ти кол-ва
function IsCorrectQuantity%{$prefix}%(id){
	res=true;
	
	//проверим цену
	sum=$("#quantity"+id+"%{$prefix}%").val();	
	sum=sum.replace("\,","\.");
	if((sum.length==0)||isNaN(sum)||(parseFloat(sum)<0)){
		$("#quantity"+id+"%{$prefix}%").addClass("wrong");
		 
		alert("Некорректно заполнено поле Количество!");
		$("#quantity"+id+"%{$prefix}%").focus();
		res=res&&false;	
	}else{
		$("#quantity"+id+"%{$prefix}%").removeClass("wrong");
	}
	
	
	
	return res;	
}


//проверка на взаимокорректность скидок (скидка не м.б. больше максимальной)
function IsCorrectBounds%{$prefix}%(id){
	var res=true;
	
	%{section name=discssec loop=$discs}%
	/*can_override_manager_discount*/
	//блок должен НЕ работать, если скидка введена программно в неактивное поле Скидка рук-ля
	 
	%{if  !($discs[discssec].id==2 and !$can_override_ruk_discount)}%
	%{if  ($discs[discssec].id==1 and !$can_override_ruk_discount) or ($discs[discssec].id==2 and !$can_override_ruk_discount) }%
	var local_res=true;
	
	//перебрать все ненулевые количества и для этих позиций выполнить проверки корректности
	$.each($("input[id^=quantity]"),function(k,v){
			 id=$(v).attr("id");
			 id=id.replace(/^quantity/,'');
			 id=id.replace('%{$prefix}%', '');
			 //alert(id);
			 
			 if($(v).val()!=0){
				
			
				sum=$("#price"+id+"%{$prefix}%").val();	
				sum=sum.replace("\,","\.");
				
				sk=$("#discount_"+"%{$discs[discssec].id}%"+"_"+"%{$prefix}%").val();	
				sk=sk.replace("\,","\.");
				
				max_sk=$("#dl_value_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").val();	
				max_sk=max_sk.replace("\,","\.");
				
				
				sk_in_rub=0;
				max_sk_in_rub=0;
				
				if($("#discount_rub_or_percent_"+"%{$discs[discssec].id}%"+"_"+"%{$prefix}%").val()==1){
					sk_in_rub=roundPlus(parseFloat(sum)*parseFloat(sk)/100,0);	
				}else{
					sk_in_rub=roundPlus(sk,0);
				}
				
				
				max_sk_descr='';
				if(max_sk!=""){
					if($("#dl_rub_or_percent_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").val()==1){
						max_sk_in_rub=roundPlus(parseFloat(sum)*parseFloat(max_sk)/100,0);	
						max_sk_descr=max_sk+'% ';
					}else{
						max_sk_in_rub=roundPlus(max_sk,0);
						max_sk_descr=max_sk+' руб. ';
					}
				}else max_sk_in_rub=sum;
				
				
				
				//блок должен работать, только если НЕ введена 	программно скидка менеджером в поле скидка рук-ля
				if(parseFloat(sk)>parseFloat(max_sk)){
					res=res&&false;
					alert("Введенная скидка превышает максимальную скидку "+max_sk_descr+"!");
					$("#discount_"+"%{$discs[discssec].id}%"+"_"+"%{$prefix}%").addClass("wrong");
					$("#dl_value_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").addClass("wrong");	
					/*alert("Внимание! Введенная Вами скидка "+sk+"% превышает максимальную скидку "+max_sk_descr+".\nУтвердить эту скидку имеют право следующие сотрудники: %{strip}%
		%{foreach name=us from=$users_can_override_ruk_discount item=user}%
		%{$user.name_s}% (%{$user.login}%)%{if !$smarty.foreach.us.last}%, %{/if}%
		
		%{/foreach}%
		%{/strip}%!");*/
				}else{
					$("#discount_"+"%{$discs[discssec].id}%"+"_"+"%{$prefix}%").removeClass("wrong");
					$("#dl_value_"+"%{$discs[discssec].id}%"+"_"+id+"%{$prefix}%").removeClass("wrong");	
				}
			
			 }
	
	});
	%{/if}%
	%{/if}%
	%{/section}%
	
	return res;	
}



//проверка корр-ти доп.наценки
function IsCorrectExtraCharges%{$prefix}%(id){
	res=true;
	
	//проверим цену
	sum=$("#extra_charges"+id+"%{$prefix}%").val();	
	sum=sum.replace("\,","\.");
	if((sum.length==0)||isNaN(sum)||(parseFloat(sum)<0)){
		$("#extra_charges"+id+"%{$prefix}%").addClass("wrong");
		alert("Некорректно заполнено поле Дополнительная наценка!");
		$("#extra_charges"+id+"%{$prefix}%").focus();
		res=res&&false;	
	}else{
		$("#extra_charges"+id+"%{$prefix}%").removeClass("wrong");
	}
	
	
	
	return res;	
}

//проверка корр-ти цены
//проверка корр-ти скидки (любой)





$(function(){
	
	
/*подгрузить старые значения, если они есть*/
 
%{section name=rowsec loop=$items}%
 
	do_reload=false;
	ret=$.cookie('quantity%{$items[rowsec].pl_id}%%{$prefix}%');
	if(ret!=undefined) {
		
		
		$("#quantity%{$items[rowsec].pl_id}%%{$prefix}%").val(ret);
		do_reload=do_reload||true;
	}
	
	
		ret=$.cookie('print_form_has_komplekt%{$items[rowsec].pl_id}%%{$prefix}%');
		if(ret!=undefined) {
			 $("#print_form_has_komplekt%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", ret=="1");
			do_reload=do_reload||true;
		}else{
			//$("#quantity%{$option.pl_id}%%{$prefix}%").val($("#quantity%{$option.parent_id}%%{$prefix}%").val());
			//do_reload=do_reload||true;
		}
		
	ret=$.cookie('extra_charges%{$items[rowsec].pl_id}%%{$prefix}%');
		if(ret!=undefined) {
			 $("#extra_charges%{$items[rowsec].pl_id}%%{$prefix}%").val(ret);
			do_reload=do_reload||true;
		} 
	
	
	%{foreach from=$items[rowsec].discs1 item=discs1}%
	 ret= $.cookie('discount_%{$discs1.id}%_%{$prefix}%');
	 if(ret!=undefined) {
		 $("#discount_%{$discs1.id}%_%{$prefix}%").val(ret);
		do_reload=do_reload||true;
	}
	%{/foreach}%
	
	
	
	
	//если найдено хоть 1 значение - подставить его
	if(do_reload){
		RecalcPrice%{$prefix}%("%{$items[rowsec].pl_id}%");	
	}

%{/section}%
 
%{foreach from=$discs item=discs1}%
 
	 //обработчик изменения скидки (любой)
	 $("#discount_%{$discs1.id}%_%{$prefix}%").bind("keypress", function(e){
		if(e.keyCode==13){
			$("#discount_%{$discs1.id}%_%{$prefix}%").trigger("change");
			
			e.stopPropagation();	
			e.preventDefault();
		}
						
	});
	 
	 $("#discount_%{$discs1.id}%_%{$prefix}%").bind("change", function(){
		 
		 // alert('1');
		  //сброс прочих скидок
		  if(parseFloat($(this).val())!==0){
				%{foreach from=$discs item=discs2}%
				 %{if $discs2!=$discs1}%
				 $("#discount_%{$discs2.id}%_%{$prefix}%").val('0');
				 //обнулить скидку рук-ля у опции, сделать ее неактивной
				 //если выбрана скидка мен-ра
				 $("input[id^=discount_%{$discs2.id}%_]").val('0');
				 
				 %{/if}%
				 %{/foreach}% 
		  }
		  
		  res=true;
		   res=res&&IsCorrectSk%{$prefix}%("");
		   if(res) res=res&&IsCorrectBounds%{$prefix}%("");
		  
		  //перебрать все ненулевые количества и для этих позиций выполнить проверки корректности
		  $.each($("input[id^=quantity]"),function(k,v){
			 id=$(v).attr("id");
			 id=id.replace(/^quantity/,'');
			 id=id.replace('%{$prefix}%', '');
			 //alert(id);
			 
			 if($(v).val()!=0){
				 if(res) res=res&&IsCorrectQuantity%{$prefix}%(id);
		 		 if(res) res=res&&IsCorrectExtraCharges%{$prefix}%(id);
		 		 if(res) res=res&&RecalcPrice%{$prefix}%(id);		 
				 //alert('z');
			 }
		  });
		 
		/*  res=true;
		  res=res&&IsCorrectSk%{$prefix}%("%{$items[rowsec].pl_id}%");
		  if(res) res=res&&IsCorrectBounds%{$prefix}%("%{$items[rowsec].pl_id}%");
		  if(res) res=res&&IsCorrectQuantity%{$prefix}%("%{$items[rowsec].pl_id}%");
		   if(res) res=res&&IsCorrectExtraCharges%{$prefix}%("%{$items[rowsec].pl_id}%");
		  if(res) res=res&&RecalcPrice%{$prefix}%("%{$items[rowsec].pl_id}%");*/
		  
		 //  if(res) $("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", true);
		 //  else $("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", false);*/
		   
		   %{if $memory==1}%
		 	 if(res){
				  $.cookie('discount_%{$discs1.id}%_%{$prefix}%', $("#discount_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%").val());
				 %{foreach from=$discs item=discs2}%
				 %{if $discs2!=$discs1}%
				 $.cookie('discount_%{$discs2.id}%_%{$prefix}%', 0);
				 %{/if}%  
				 %{/foreach}%
			 }
		   %{/if}%
	 });
	 
	 
	 
	 $("#discount_rub_or_percent_%{$discs1.id}%_%{$prefix}%").bind("change", function(){
		 res=true;
		 res=res&&IsCorrectSk%{$prefix}%("%{$items[rowsec].pl_id}%");
		 if(res) res=res&&IsCorrectBounds%{$prefix}%("%{$items[rowsec].pl_id}%");
		 if(res) res=res&&IsCorrectQuantity%{$prefix}%("%{$items[rowsec].pl_id}%");
		  if(res) res=res&&IsCorrectExtraCharges%{$prefix}%("%{$items[rowsec].pl_id}%");
		 if(res) res=res&&RecalcPrice%{$prefix}%("%{$items[rowsec].pl_id}%");
		 
		 if(res) $("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", true);
		 else $("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", false);
	 });
	 
%{/foreach}%



%{section name=rowsec loop=$items}%

	$("#quantity%{$items[rowsec].pl_id}%%{$prefix}%").bind("keypress", function(e){
		if(e.keyCode==13){
			$("#quantity%{$items[rowsec].pl_id}%%{$prefix}%").trigger("change");
			e.stopPropagation();
			e.preventDefault();
		}
		
						
	});
	
	$("#price%{$items[rowsec].pl_id}%%{$prefix}%").bind("keypress", function(e){
		if(e.keyCode==13){
			$("#price%{$items[rowsec].pl_id}%%{$prefix}%").trigger("change");
			e.stopPropagation();
			e.preventDefault();
		}				
	});
	
	
	$("#extra_charges%{$items[rowsec].pl_id}%%{$prefix}%").bind("keypress", function(e){
		if(e.keyCode==13){
			$("#extra_charges%{$items[rowsec].pl_id}%%{$prefix}%").trigger("change");
			e.stopPropagation();
			e.preventDefault();
		}				
	});
	
	
	$("#quantity%{$items[rowsec].pl_id}%%{$prefix}%").bind("change", function(){
		 
	//	alert('zz'); 
		 
		res=true;
		res=res&&IsCorrectPrice%{$prefix}%("%{$items[rowsec].pl_id}%");
		if(res) res=res&&IsCorrectQuantity%{$prefix}%("%{$items[rowsec].pl_id}%");
		 if(res) res=res&&IsCorrectExtraCharges%{$prefix}%("%{$items[rowsec].pl_id}%");
		if(res) res=res&&IsCorrectBounds%{$prefix}%("%{$items[rowsec].pl_id}%");
		
		%{if $id!=""}%
		//при смене кол-ва товара менять кол-во выделенных опций
		if(res) $("input[id^=parent_id]").each(function(index, element) {
        	//нужен ключ
			opt_id=$(element).attr("id").replace(/^parent_id/,'').replace(/%{$prefix}%$/,'');
			if(($(element).val()=="%{$items[rowsec].pl_id}%")&&($("#q_a"+opt_id+"%{$prefix}%").prop("checked"))) {
				// alert('zz');
				 $("#quantity"+opt_id+"%{$prefix}%").val($("#quantity%{$items[rowsec].pl_id}%%{$prefix}%").val());
			}
        });
		 %{/if}%
		if(res) res=res&&RecalcPrice%{$prefix}%("%{$items[rowsec].pl_id}%");
		
		  
		 if(res&&$("#quantity%{$items[rowsec].pl_id}%%{$prefix}%").val()>0) $("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", true);
		 else $("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", false);
		 
		  
		  if(res) $.cookie('quantity%{$items[rowsec].pl_id}%%{$prefix}%', $("#quantity%{$items[rowsec].pl_id}%%{$prefix}%").val());
		 
		 
		 
		
		 
	});
	
	
	
	
	 
	 
	
	
	
	$("#price%{$items[rowsec].pl_id}%%{$prefix}%").bind("change", function(){
		
		res=true;
		res=res&&IsCorrectPrice%{$prefix}%("%{$items[rowsec].pl_id}%");
		if(res) res=res&&IsCorrectQuantity%{$prefix}%("%{$items[rowsec].pl_id}%");
		if(res) res=res&&IsCorrectBounds%{$prefix}%("%{$items[rowsec].pl_id}%");
		 if(res) res=res&&IsCorrectExtraCharges%{$prefix}%("%{$items[rowsec].pl_id}%");
		if(res) res=res&&RecalcPrice%{$prefix}%("%{$items[rowsec].pl_id}%");
		
		 if(res) $("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", true);
		 else $("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", false);
		
		$("#price_was_changed%{$items[rowsec].pl_id}%%{$prefix}%").val('1');

		
	});
	
	
	
	 
	
	
	//изменение доп. наценки	
	 $("#extra_charges%{$items[rowsec].pl_id}%%{$prefix}%").bind("change", function(){
		 res=true;
		  res=res&&IsCorrectMaxSk%{$prefix}%("%{$items[rowsec].pl_id}%");
		  if(res) res=res&&IsCorrectBounds%{$prefix}%("%{$items[rowsec].pl_id}%");
		//  if(res) res=res&&IsCorrectQuantity%{$prefix}%("%{$items[rowsec].pl_id}%");
		 if(res) res=res&&IsCorrectExtraCharges%{$prefix}%("%{$items[rowsec].pl_id}%");
		  if(res) res=res&&RecalcPrice%{$prefix}%("%{$items[rowsec].pl_id}%");
		  
		  
		   %{if $memory==1}%
		 	 if(res){
				  $.cookie('extra_charges%{$items[rowsec].pl_id}%%{$prefix}%', $("#extra_charges%{$items[rowsec].pl_id}%%{$prefix}%").val());
			 }
	 	   %{/if}%
		  
		   if(res) $("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", true);
		 else $("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", false);
	 });
	
	
	 %{foreach from=$items[rowsec].discs1 item=discs1}%
	 
	 //обработчик изменения макс скидки (любой)
	 $("#dl_value_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%").bind("keypress", function(e){
		if(e.keyCode==13){
			$("#dl_value_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%").trigger("change");
			e.stopPropagation();
			e.preventDefault();
		}				
	});
	 
	 $("#dl_value_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%").bind("change", function(){
		 res=true;
		  res=res&&IsCorrectMaxSk%{$prefix}%("%{$items[rowsec].pl_id}%");
		  if(res) res=res&&IsCorrectBounds%{$prefix}%("%{$items[rowsec].pl_id}%");
		//  if(res) res=res&&IsCorrectQuantity%{$prefix}%("%{$items[rowsec].pl_id}%");
		 if(res) res=res&&IsCorrectExtraCharges%{$prefix}%("%{$items[rowsec].pl_id}%");
		  if(res) res=res&&RecalcPrice%{$prefix}%("%{$items[rowsec].pl_id}%");
		  
		  
		  
		   if(res) $("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", true);
		 else $("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", false);
	 });
	 
	 
	 $("#dl_rub_or_percent_%{$discs1.id}%_%{$items[rowsec].pl_id}%%{$prefix}%").bind("change", function(){
		 res=true;
		 res=res&&IsCorrectMaxSk%{$prefix}%("%{$items[rowsec].pl_id}%");
		 if(res) res=res&&IsCorrectBounds%{$prefix}%("%{$items[rowsec].pl_id}%");
		// if(res) res=res&&IsCorrectQuantity%{$prefix}%("%{$items[rowsec].pl_id}%");
		 if(res) res=res&&IsCorrectExtraCharges%{$prefix}%("%{$items[rowsec].pl_id}%");
		 if(res) res=res&&RecalcPrice%{$prefix}%("%{$items[rowsec].pl_id}%");
		 
		  if(res) $("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", true);
		 else $("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").prop("checked", false);
	 });
	
	 %{/foreach}%
	
	
	
	
	
	
	
	
	$("#do_update_%{$items[rowsec].pl_id}%%{$prefix}%").bind("change", function(){
		if($(this).prop("checked")){
			 res=true;
		 res=res&&IsCorrectMaxSk%{$prefix}%("%{$items[rowsec].pl_id}%");
		  if(res) res=res&&IsCorrectSk%{$prefix}%("%{$items[rowsec].pl_id}%");
		 if(res) res=res&&IsCorrectBounds%{$prefix}%("%{$items[rowsec].pl_id}%");
		  if(res) res=res&&IsCorrectExtraCharges%{$prefix}%("%{$items[rowsec].pl_id}%");
		 
		 if(res) res=res&&RecalcPrice%{$prefix}%("%{$items[rowsec].pl_id}%");
			
			
			if(!res) $(this).prop("checked", false);
		}
	});
	
	
	
	
	 
%{/section}%
	
	 $("input#price_f%{$prefix}%").bind("keypress", function(e){
		if(e.keyCode==13){
			$("input#price_f%{$prefix}%").trigger("change");
			e.stopPropagation();
			e.preventDefault();
		}				
	}); 
	
	
	
	
	
	$("input#price_f%{$prefix}%").bind("change", function(){
		 
		var res=true;
		res=res&&IsCorrectPriceF%{$prefix}%();
		
		$("input[id^=quantity]").each(function(index, v) {
			id=$(v).attr("id").replace(/^quantity/,'').replace(/%{$prefix}%$/,'');
			if(parseFloat($(v).val().replace(/\,/,'.'))>0){
				
				if(res) res=res&&IsCorrectPrice%{$prefix}%(id);
				if(res) res=res&&IsCorrectQuantity%{$prefix}%(id);
				if(res) res=res&&IsCorrectExtraCharges%{$prefix}%(id);
				if(res) res=res&&IsCorrectBounds%{$prefix}%(id);
		
		
				
				 
			}
		 });
	 
		
		

		if(res){
			//alert('z!');
			FindSkBySum%{$prefix}%();
		}

		
	});


});

%{/if}%

</script>