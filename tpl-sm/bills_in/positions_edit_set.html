<!-- таблица в диалоге -->

<div id="info_positions_dialog" title="О позиции">
<div id="position_info"></div>

</div>
 <script type="text/javascript">
  $(function(){
     $("#info_positions_dialog").dialog({
	  autoOpen: false,
	  modal: true,
	  width: 450,
	  height: 250,
	  buttons: {
		  "Закрыть": function(){
		   $(this).dialog("close");	
		  }
		}
	 });
	 
	
	
  });
</script>

<script type="text/javascript">
//общие функции для каждого ряда в счете
function roundPlus(x, n) { //x - число, n - количество знаков
  if(isNaN(x) || isNaN(n)) return false;
  var m = Math.pow(10,n);
  return Math.round(x*m)/m;
}



//служебная функция определения вел-ны скидки от заданной нач цены
function find_skika_by_price(price,hash){
	 sk=0;
	 mode=0;
	 
	
	 return parseFloat(sk);
	
}

//служебная функция определения вел-ны +/- при известной цене со скидкой
function find_pm_by_price_f(price_f, hash){
	pm=0;
	
	if($("#do_pm_"+hash).prop("checked")){
	  
	  
	  pm=$("#value_"+hash).val();	
	  pm=pm.replace("\,","\.");
	  if(isNaN(parseFloat(pm))) pm=0.0;	
	  
	  
	  if($("#rub_or_percent_"+hash).val()==1){
		 pm=price_f*parseFloat(pm)/100; 
	  }
	  
	  if($("#plus_or_minus_"+hash).val()==1){
		pm=pm*-1.0;  
	  }
	  
	}
	return parseFloat(pm);	
}

//служебная функция найти цену со скидкой при известной итоговой цене
function find_price_f_by_price_pm(price_pm, hash){
	price_f=parseFloat(price_pm);
	
	if($("#do_pm_"+hash).prop("checked")){
	  
	  
	  pm=$("#value_"+hash).val();	
	  pm=pm.replace("\,","\.");
	  
	  
	  if(isNaN($("#value_"+hash).val().replace("\,","\."))){
		value=0.0;  
	  }else value=parseFloat($("#value_"+hash).val().replace("\,","\."));
	  
	  
		if($("#rub_or_percent_"+hash).val()==0){
			if($("#plus_or_minus_"+hash).val()==0){
				price_f=price_pm-parseFloat(value);
			}else{
				//slag=-1.0*slag;
				price_f=price_pm+parseFloat(value);
			}
			
		}else{
			
	  
			if($("#plus_or_minus_"+hash).val()==0){
				price_f=price_pm*100/(100+parseFloat(value));
				
			}else{
				price_f=price_pm*100/(100-parseFloat(value));
			}
			
		}
	}
	
	return parseFloat(price_f);	
}


//служебная функция найти цену по заданной цене с скидкой
function find_price_by_pricef(price_f,hash){
	price=parseFloat(price_f);
	sk=0;
	 mode=0;
	 
	
	 
	 return parseFloat(price);
	
}


//служебная функция найти сумму ндс по стоимости
function find_nds_by_cost(cost, hash){
	return parseFloat(cost)*parseFloat($("#quantity_"+hash).attr("value").replace("\,","\."))-parseFloat(cost)*parseFloat($("#quantity_"+hash).attr("value").replace("\,","\."))/1.18;
}





//смена поля +/-
function PMChanged(hash){
	//ищем итог цену с учеом стоимости
	
	//сменить итоговую цену со скидкой
	p=0;
	if(parseFloat($("#quantity_"+hash).val())!=0){
		p=roundPlus(parseFloat($("#total_check_"+hash).val().replace("\,","\."))/parseFloat($("#quantity_"+hash).val().replace("\,","\.")),2);
	
	}else{
		p=parseFloat($("#price_f_"+hash).val().replace("\,","\."))	
	}
	
	//куда девать остаток от деления, чтобы сошлось по счету????
	
	
	$("#price_pm_check_"+hash).val(p);
	price_f=parseFloat(p);
	//сменить начальную цену
	if($("#do_pm_"+hash).prop("checked")){
		//есть +-/
		
		//slag=1;
		pi=p;
		
		if(isNaN($("#value_"+hash).val().replace("\,","\."))){
				value=0;
		}else value=$("#value_"+hash).val().replace("\,","\.");
			
		
		
		if($("#rub_or_percent_"+hash).val()==0){
			
			if($("#plus_or_minus_"+hash).val()==0){
				pi=parseFloat(p)-parseFloat(value);
			}else{
				//slag=-1.0*slag;
				pi=parseFloat(p)+parseFloat(value);
			}
			//alert('zz'+pi);
		
		}else{
			pi=p;
		
			
			if(parseFloat($("#value_"+hash).val())!=0){
			
			  if($("#plus_or_minus_"+hash).val()==0){
				  pi=p*100/(100+parseFloat(value));
				  
			  }else{
				  pi=p*100/(100-parseFloat(value));
			  }
			}
		}
		
		if(isNaN(pi)) pi=price_f;
		price_f=pi;
		pi=roundPlus(pi,2);
		
		$("#price_f_"+hash).val(pi);	
		//$("#span_price_"+hash).html(pi);	
		//alert(price_f);
	}else{
		if(isNaN(p)) p=price_f;
		price_f=p;
		$("#price_f_"+hash).val(p);	
		//$("#span_price_"+hash).html(p);	
	}
	
	$("#price_"+hash).val(roundPlus(find_price_by_pricef(price_f, hash),2));
	
	
	//alert(roundPlus(price_f*parseFloat($("#quantity_"+hash).val().replace("\,","\.")),2));
	$("#cost_f_"+hash).html(roundPlus(price_f*parseFloat($("#quantity_"+hash).val().replace("\,","\.")),2));
	
	$("#nds_summ_"+hash).html(roundPlus(p*parseFloat($("#quantity_"+hash).attr("value").replace("\,","\."))-p*parseFloat($("#quantity_"+hash).attr("value").replace("\,","\."))/1.18,2));
	
}

//проверка добавки цены
function value_changed(hash){
	ret=true;
				
				if($("#value_"+hash).attr("value").length==0){
					alert("Заполните поле +/-!");
					ret=ret&&false;
					//return false;	
				}
				
				rev_value=$("#value_"+hash).attr("value");
				rev_value=rev_value.replace("\,","\.");
				
				
				if(isNaN(rev_value)||(parseFloat(rev_value)<0)){
					alert("Неверное значение в поле +/-!\nЕсли Вы вводите дробное значение, просьба отделять дробную часть от целой символом точки.");
					ret=ret&&false;
				}
				
				
				
				if(!ret) {
					$("#value_"+hash).addClass("wrong");
					$("#value_"+hash).focus();
				}else{
					//peres4et	
					$("#value_"+hash).removeClass("wrong");	
					
					PMChanged(hash);
				}
				
				//проверка итоговой цены
				
				
				return ret;
}


//режим +/- активировать
function do_pm(hash){
	if($("#do_pm_"+hash).prop("checked")){
					$("#plus_or_minus_"+hash).attr("disabled",false);
					$("#value_"+hash).attr("disabled",false);
					$("#rub_or_percent_"+hash).attr("disabled",false);
					
					$("#discount_plus_or_minus_"+hash).attr("disabled",false);
					$("#discount_value_"+hash).attr("disabled",false);
					$("#discount_rub_or_percent_"+hash).attr("disabled",false);
							
				}else{
					$("#plus_or_minus_"+hash).attr("disabled",true);
					$("#value_"+hash).attr("disabled",true);
					$("#rub_or_percent_"+hash).attr("disabled",true);
					
					$("#discount_plus_or_minus_"+hash).attr("disabled",true);
					$("#discount_value_"+hash).attr("disabled",true);
					$("#discount_rub_or_percent_"+hash).attr("disabled",true);
				}	
}

//проверка итоговой цены
function price_pm_check(hash){
	ret=true;
				
				if($("#price_pm_check_"+hash).attr("value").length==0){
					alert("Заполните поле Итоговая цена!");
					ret=ret&&false;
					//return false;	
				}
				
				
				rev_value=$("#price_pm_check_"+hash).attr("value");
				rev_value=rev_value.replace("\,","\.");
				
				
				if(isNaN(rev_value)||(parseFloat(rev_value)<0)){
					alert("Неверное значение в поле Итоговая цена!\nЕсли Вы вводите дробное значение (копейки), просьба отделять дробную часть от целой символом точки.");
					ret=ret&&false;
				}
				
				
				
				if(!ret){
					 $("#price_pm_check_"+hash).focus();
					 $("#price_pm_check_"+hash).addClass("wrong");
				}else{
					//peres4et	
					$("#price_pm_check_"+hash).removeClass("wrong");
					//PIchanged(hash);
					
					//меняется цена со скидкой
					price_f=find_price_f_by_price_pm(parseFloat(rev_value),hash);
					$("#price_f_"+hash).val(roundPlus(price_f,2));
					
					//меняется цена без скидки
					price=find_price_by_pricef(price_f,hash);
					$("#price_"+hash).val(roundPlus(price,2));
					
					//меняется стоимость и ндс
					//меняется сумма с учетом скидки
					cost_f=parseFloat($("#quantity_"+hash).val())*price_f;
					$("#cost_"+hash).html(roundPlus(cost_f,2));
					
					cost=parseFloat($("#quantity_"+hash).val())*rev_value;
					$("#total_check_"+hash).val(roundPlus(cost,2));
					
					nds=find_nds_by_cost(cost, hash);
					$("#nds_summ_"+hash).html(roundPlus(nds,2));
					
				}
				
				
				return ret;	
}

//проверка стоимости!!!!
function total_check(hash){
		ret=true;
				
				if($("#total_check_"+hash).attr("value").length==0){
					alert("Заполните поле Всего!");
					ret=ret&&false;
					//return false;	
				}
				
				rev_value=$("#total_check_"+hash).attr("value");
				rev_value=rev_value.replace("\,","\.");
				
				
				if(isNaN(rev_value)||(parseFloat(rev_value)<=0)){
					alert("Неверное значение в поле Всего!\nЕсли Вы вводите дробное значение (копейки), просьба отделять дробную часть от целой символом точки.");
					ret=ret&&false;
				}
				
				
				
				if(!ret){
					 $("#total_check_"+hash).focus();
					 $("#total_check_"+hash).addClass("wrong");
				}else{
					//peres4et	
					$("#total_check_"+hash).removeClass("wrong");
					
					
					//меняем цену с +/-
					price_pm=parseFloat(rev_value)/parseFloat($("#quantity_"+hash).val());					
					$("#price_pm_check_"+hash).val(roundPlus(price_pm,2));
					
					//меняем цену со скидкой
					price_f=find_price_f_by_price_pm(price_pm,hash);
					$("#price_f_"+hash).val(roundPlus(price_f,2));
					
					//меняем стоимость со скидкой
					cost_f=parseFloat($("#quantity_"+hash).val())*price_f;
					$("#cost_"+hash).html(roundPlus(cost_f,2));
					
					//меняем ндс
					nds=find_nds_by_cost(parseFloat(rev_value), hash);
					$("#nds_summ_"+hash).html(roundPlus(nds,2));
					
					
					//меняем цену
					price=find_price_by_pricef(price_f,hash);
					$("#price_"+hash).val(roundPlus(price,2));
					
				}
				
				return ret;
}


//проверка дисконта
function discount_value(hash){
	ret=true;
				
				if($("#discount_value_"+hash).attr("value").length==0){
					alert("Заполните поле Дисконт +/-!");
					ret=ret&&false;
					//return false;	
				}
				
				
				rev_value=$("#discount_value_"+hash).attr("value");
				rev_value=rev_value.replace("\,","\.");
				
				if(isNaN(rev_value)||(parseFloat(rev_value)<0)){
					alert("Неверное значение в поле Дисконт +/-!\nЕсли Вы вводите дробное значение, просьба отделять дробную часть от целой символом точки.");
					ret=ret&&false;
				}
				
				
				
				if(!ret) {
					$("#discount_value_"+hash).addClass("wrong");
					$("#discount_value_"+hash).focus();
				}else{
					//peres4et	
					$("#discount_value_"+hash).removeClass("wrong");	
					
				
				}
				
				
				return ret;
}


//провекра количества
function quantity_check(hash){
	ret=true;
	
	
	if($("#quantity_"+hash).attr("value").length==0){
		alert("Заполните поле Количесто!");
		ret=ret&&false;
		//return false;	
	}
	
	rev_value=$("#quantity_"+hash).attr("value");
	rev_value=rev_value.replace("\,","\.");
	
	if(isNaN(rev_value)||(parseFloat(rev_value)<0)){
		alert("Неверное значение в поле Количество!");
		ret=ret&&false;
	}

	if(!ret) {
		$("#quantity_"+hash).addClass("wrong");
		$("#quantity_"+hash).focus();
	}else{
		//peres4et	
		$("#quantity_"+hash).removeClass("wrong");
		
		
		//меняется сумма с учетом скидки
		cost_f=parseFloat($("#quantity_"+hash).val())*parseFloat($("#price_f_"+hash).val());
		$("#cost_f_"+hash).html(roundPlus(cost_f,2));
		
		cost=parseFloat($("#quantity_"+hash).val())*parseFloat($("#price_pm_check_"+hash).val());
		$("#total_check_"+hash).val(roundPlus(cost,2));
		
		nds=find_nds_by_cost(cost, hash);
		$("#nds_summ_"+hash).html(roundPlus(nds,2));
	}
	return ret;	
}



//проверка стартовой цены
function price_сheck(hash){
	ret=true;
				
				if($("#price_"+hash).attr("value").length==0){
					alert("Заполните поле Цена с НДС!");
					ret=ret&&false;
					//return false;	
				}
				
				
				rev_value=$("#price_"+hash).attr("value");
				rev_value=rev_value.replace("\,","\.");
				
				
				if(isNaN(rev_value)||(parseFloat(rev_value)<0)){
					alert("Неверное значение в поле Цена с НДС!\nЕсли Вы вводите дробное значение (копейки), просьба отделять дробную часть от целой символом точки.");
					ret=ret&&false;
				}
				
				
				
				if(!ret){
					 $("#price_"+hash).focus();
					 $("#price_"+hash).addClass("wrong");
				}else{
					//peres4et	
					$("#price_"+hash).removeClass("wrong");
					
					//меняется цена со скидкой
					price_f=parseFloat(rev_value)-find_skika_by_price(rev_value, hash);
					$("#price_f_"+hash).val(roundPlus(price_f,2));
					
					//меняется сумма с учетом скидки
					cost_f=parseFloat($("#quantity_"+hash).val())*price_f;
					$("#cost_"+hash).html(roundPlus(cost_f,2));
					
					//меняется цена +/-
					price_pm=parseFloat(price_f)+ find_pm_by_price_f(price_f, hash);
					$("#price_pm_check_"+hash).val(roundPlus(price_pm,2));
					
					cost=parseFloat($("#quantity_"+hash).val())*price_pm;
					$("#total_check_"+hash).val(roundPlus(cost,2));
					
					nds=find_nds_by_cost(cost, hash);
					$("#nds_summ_"+hash).html(roundPlus(nds,2));
				}
				
				
				return ret;	
}


//проверка цены со скидкой
function price_f_сheck(hash){
	ret=true;
				
				if($("#price_f_"+hash).attr("value").length==0){
					alert("Заполните поле Цена с НДС с учетом скидки!");
					ret=ret&&false;
					//return false;	
				}
				
				
				rev_value=$("#price_f_"+hash).attr("value");
				rev_value=rev_value.replace("\,","\.");
				
				
				if(isNaN(rev_value)||(parseFloat(rev_value)<0)){
					alert("Неверное значение в поле Цена с НДС с учетом скидки!\nЕсли Вы вводите дробное значение (копейки), просьба отделять дробную часть от целой символом точки.");
					ret=ret&&false;
				}
				
				
				
				if(!ret){
					 $("#price_f_"+hash).focus();
					 $("#price_f_"+hash).addClass("wrong");
				}else{
					//peres4et	
					$("#price_f_"+hash).removeClass("wrong");
					
					
					
					//меняется цена исходная
					price=find_price_by_pricef(rev_value, hash);
					$("#price_"+hash).val(roundPlus(price,2));
					
					//меняется сумма с учетом скидки
					cost_f=parseFloat($("#quantity_"+hash).val())*rev_value;
					$("#cost_"+hash).html(roundPlus(cost_f,2));
					
					
					//меняется цена с +/-
					price_pm=parseFloat(rev_value)+ find_pm_by_price_f(rev_value, hash);
					$("#price_pm_check_"+hash).val(roundPlus(price_pm,2));
					
					//меняется стоимость
					cost=parseFloat($("#quantity_"+hash).val())*price_pm;
					$("#total_check_"+hash).val(roundPlus(cost,2));
					
					nds=find_nds_by_cost(cost, hash);
					$("#nds_summ_"+hash).html(roundPlus(nds,2));
					//меняется ндс
				}
				
				
				return ret;	
}


//смена скидок
//function pl_discount_check(hash){
	


//проверка на взаимокорректность скидок (скидка не м.б. больше максимальной)
//function IsCorrectBounds(hash){
	

function link_in_sh(position_id, pl_position_id, pl_discount_id, pl_discount_value, pl_discount_rub_or_percent, out_bill_id){
	
	
				$.ajax({
					async: true,
					url: "/js/bill_in.php",
					type: "POST",
					data:{
						"action":"find_sh_pos",
						"position_id":position_id,
						"pl_position_id":pl_position_id,
						"pl_discount_id":pl_discount_id,
						"pl_discount_value":pl_discount_value,
						"pl_discount_rub_or_percent":pl_discount_rub_or_percent,
						"out_bill_id":out_bill_id,
						"bill_id":$("#id").val()
					},
					beforeSend: function(){
					  $("#position_info").html('<img src="/img/images/wait.gif" width="32" height="32" alt="подождите, пожалуйста..." border="0" />');
					},
					success: function(data){
					  $("#position_info").html(data);
					  
					},
					error: function(xhr, status){
					   // $("#pos_rows").html("Ошибка загрузки позиций.");	
					}	 
				  });
				
				$("#info_positions_dialog").dialog("open");
				return false;
			
}
</script>

<div id="positions_scroll_block" style="/*overflow:auto; width: 1200px; height:580px;*/"  >

<div style="padding-right:0px; padding-top:0px;">
<em>Все цены указаны в рублях РФ.</em>
</div>

<strong>Позиции в счете:</strong>   
<table width="100%" cellpadding="1" cellspacing="0" border="0" class="blacktable">
    <thead>
    <tr align="center" valign="top">
    	<th scope="col" width="20">Код</th>
        <th scope="col" width="60%">Наименование</th>
        <th scope="col" width="40">Ед. изм.</th>
        
        <th scope="col" width="40">Кол-во</th>
        
        <th scope="col" width="40" style="display:none;">Доступное кол-во</th>
        <th scope="col" width="40">В расп. на приемку</th>
        
     
        
        
        <th scope="col" width="80" %{if $cannot_view_pm}% style="display:none;"%{/if}%>Цена с НДС</th>
        
             
     
        
        
        <th scope="col" %{if $cannot_view_pm}% style="display:none;"%{/if}%>+/-</th>
         <th scope="col" %{if $cannot_view_pm}% style="display:none;"%{/if}%>Дисконт +/-</th>
        <th scope="col" width="80">Итоговая цена</th>
    
    
         <th scope="col" width="80" %{if $cannot_view_pm}% style="display:none;"%{/if}%>Сумма </th>
        <th scope="col" width="80">% НДС</th>
        <th scope="col" width="80">Сумма НДС</th>
        <th scope="col" width="80">Всего</th>
       <th scope="col" width="100">Исходящий счет</th>
        
    </tr>
    </thead>
    <tbody id="putting_positions">
   
    %{section name=pospossec loop=$pospos}%
    %{if $pospos[pospossec].quantity>0}%
   %{include file="bills_in/positions_edit_row.html"}%
    
    %{/if}%
    %{/section}%
    </tbody>
    </table>
<br />

	%{if !$can_mod_pm_only}%
    
   
   <h4>Доступные позиции исходящих счетов:</h4>
   
    <!--форма выбора позиций других счетов -->
    %{include file="bills_in/position_edit_find_bills_form.html"}%
     
   <br />

    
    <table width="100%" cellpadding="1" cellspacing="0" border="0" class="blacktable">
    <thead>
    <tr align="center" valign="top">
    	<th scope="col" width="20">Код</th>
        <th scope="col" width="60%">Наименование</th>
        <th scope="col" width="40">Ед. изм.</th>
                 <th scope="col" width="80">Кол-во в счете</th>
        <th scope="col" width="40">Кол-во</th>
        
        <th scope="col" width="40" style="display:none;">Доступное кол-во</th>
        <th scope="col" width="40">В расп. на приемку</th>
        
     
        
        
        <th scope="col" width="80" %{if $cannot_view_pm}% style="display:none;"%{/if}%>Цена с НДС</th>
        
             
     
        
        
        
        <th scope="col" %{if $cannot_view_pm}% style="display:none;"%{/if}%>+/-</th>
         <th scope="col" %{if $cannot_view_pm}% style="display:none;"%{/if}%>Дисконт +/-</th>
        <th scope="col" width="80">Итоговая цена</th>
    
    
         <th scope="col" width="80" %{if $cannot_view_pm}% style="display:none;"%{/if}%>Сумма </th>
        <th scope="col" width="80">% НДС</th>
        <th scope="col" width="80">Сумма НДС</th>
        <th scope="col" width="80">Всего</th>
       <th scope="col" width="100">Исходящий счет</th>
        
    </tr>
    </thead>
    <tbody id="other_founded_positions">

    
  
    </tbody>
    </table>
    <br />
<br />
<br />
   
   
   
   
   
     <h4>Позиции прайс-листа:</h4>   
    
    <!--форма выбора позиций прайс-листа -->
    %{include file="bills_in/position_edit_find_form.html"}%
      
    
    
    <br />

    
    <table width="100%" cellpadding="1" cellspacing="0" border="0" class="blacktable">
    <thead>
    <tr align="center" valign="top">
    	<th scope="col" width="20">Код</th>
        <th scope="col" width="60%">Наименование</th>
        <th scope="col" width="40">Ед. изм.</th>
        
        <th scope="col" width="40">Кол-во</th>
        
        <th scope="col" width="40" style="display:none;">Доступное кол-во</th>
        <th scope="col" width="40">В расп. на приемку</th>
        
     
        
        
        <th scope="col" width="80" %{if $cannot_view_pm}% style="display:none;"%{/if}%>Цена с НДС</th>
        
             
      
        
        
        
        <th scope="col" %{if $cannot_view_pm}% style="display:none;"%{/if}%>+/-</th>
         <th scope="col" %{if $cannot_view_pm}% style="display:none;"%{/if}%>Дисконт +/-</th>
        <th scope="col" width="80">Итоговая цена</th>
    
    
         <th scope="col" width="80" %{if $cannot_view_pm}% style="display:none;"%{/if}%>Сумма</th>
        <th scope="col" width="80">% НДС</th>
        <th scope="col" width="80">Сумма НДС</th>
        <th scope="col" width="80">Всего</th>
       <th scope="col" width="100">Исходящий счет</th>
        
    </tr>
    </thead>
    <tbody id="founded_positions">

    
  
    </tbody>
    </table>
    <br />
<br />
<br />
    
    %{/if}%
    
    </div>
    
 